name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Release, Debug]
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential cmake clang-tidy cppcheck libseccomp-dev libcap-dev libbpf-dev linux-tools-common
      - name: Configure
        run: cmake -B build -S . -DCMAKE_BUILD_TYPE=${{matrix.build_type}} -DBUILD_TESTS=ON -DENABLE_SECCOMP=ON -DENABLE_CAPABILITIES=ON
      - name: Static analysis (clang-tidy)
        run: cmake --build build --target sys_scan_core -- -j$(nproc) && clang-tidy --version || true
      - name: cppcheck
        run: cppcheck --enable=warning,performance,portability --inline-suppr --quiet src || true
      - name: Build
        run: cmake --build build --config ${{matrix.build_type}} -j$(nproc)
      - name: Run tests
        run: cd build && ctest --output-on-failure

  sanitize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y clang cmake build-essential libseccomp-dev libcap-dev libbpf-dev linux-tools-common
      - name: Configure (ASan/UBSan)
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=RelWithDebInfo -DBUILD_TESTS=ON -DENABLE_SECCOMP=ON -DENABLE_CAPABILITIES=ON \
            -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_C_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer" \
            -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
            -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=address,undefined"
      - name: Build
        run: cmake --build build -j$(nproc)
      - name: Tests (sanitizers)
        run: |
          cd build
          ASAN_OPTIONS=detect_leaks=1:abort_on_error=1 UBSAN_OPTIONS=print_stacktrace=1 ctest --output-on-failure || { cat Testing/Temporary/LastTest.log || true; exit 1; }

  fuzz-smoke:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install clang
        run: sudo apt-get update && sudo apt-get install -y clang cmake build-essential libbpf-dev linux-tools-common
      - name: Configure fuzz harness
        run: |
          cmake -B build -S . -DBUILD_FUZZERS=ON -DBUILD_TESTS=OFF -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_CXX_FLAGS="-O1 -fsanitize=fuzzer,address,undefined -fno-omit-frame-pointer" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=fuzzer,address,undefined"
      - name: Build fuzz target
        run: cmake --build build -j$(nproc) --target fuzz_rules || true
      - name: Run fuzz smoke (30s)
        run: |
          if [ -f build/fuzz_rules ]; then
            ./build/fuzz_rules -max_total_time=30 || true
          fi

# دليل تكامل Siyadah VoIP - نظام الربط المتقدم

## نظرة عامة

تم تطوير نظام تكامل متطور للربط بين منصة Siyadah AI ونظام Siyadah VoIP للمكالمات الذكية. يوفر هذا التكامل ربطاً ثنائي الاتجاه لمشاركة بيانات العملاء، تسجيل المكالمات، وتحليل الأداء.

## الميزات الأساسية

### 1. تحديث بيانات العملاء التلقائي
- **استقبال تحديثات العملاء** من نظام VoIP
- **إنشاء فرص جديدة** تلقائياً للعملاء الجدد
- **تحديث بيانات الاتصال** للعملاء الموجودين
- **تتبع حالة العملاء** ومراحل المبيعات

### 2. تسجيل المكالمات المتقدم
- **تسجيل تفاصيل المكالمات** (المدة، النتيجة، الملاحظات)
- **تحليل نتائج المكالمات** وتحديث احتمالية النجاح
- **ربط المكالمات بالفرص** التجارية الموجودة
- **إنشاء أنشطة تلقائية** لكل مكالمة

### 3. تحليل الرسائل الصوتية
- **تحويل الكلام إلى نص** باستخدام الذكاء الاصطناعي
- **تحليل المشاعر** لتقييم استجابة العملاء
- **استخراج الكلمات المفتاحية** للمتابعة
- **تحديث احتمالية النجاح** بناءً على تحليل المشاعر

## تكوين النظام

### متطلبات التكامل

```javascript
// مفتاح API المطلوب
const VOIP_API_KEY = "siyadah_voip_api_key_2025_v1";

// Webhook URL للتكامل
const WEBHOOK_URL = "/api/external/webhook/your_system";

// Headers مطلوبة للمصادقة
const HEADERS = {
  "X-API-Key": "siyadah_voip_api_key_2025_v1",
  "Content-Type": "application/json"
};
```

### نقاط النهاية (Endpoints)

#### 1. Webhook الرئيسي
```
POST /api/external/webhook/your_system
Headers: X-API-Key: siyadah_voip_api_key_2025_v1
```

#### 2. حالة النظام
```
GET /api/voip/status
Headers: X-API-Key: siyadah_voip_api_key_2025_v1
```

#### 3. اختبار التكامل
```
POST /api/voip/test
No authentication required
```

## أنواع الأحداث المدعومة

### 1. تحديث العميل (customer_update)
```json
{
  "event": "customer_update",
  "data": {
    "customer_id": "12345",
    "name": "عبدالرحمن",
    "phone": "+966566100095",
    "email": "abdulrahman@example.com",
    "status": "active",
    "notes": "عميل مهتم بخدمات الذكاء الاصطناعي"
  }
}
```

**النتيجة:**
- إنشاء فرصة جديدة إذا لم يكن العميل موجوداً
- تحديث بيانات الاتصال للعملاء الموجودين
- إنشاء نشاط في سجل الأنشطة

### 2. مكالمة مكتملة (call_completed)
```json
{
  "event": "call_completed",
  "data": {
    "call_id": "CALL_1234567890",
    "customer_id": "12345",
    "phone": "+966566100095",
    "duration": 120,
    "outcome": "interested",
    "notes": "مكالمة ناجحة، العميل مهتم بالخدمات",
    "recording_url": "https://example.com/recording.mp3"
  }
}
```

**النتيجة:**
- تسجيل المكالمة في سجل الأنشطة
- تحديث احتمالية نجاح الفرصة بناءً على النتيجة
- ربط المكالمة بالعميل والفرصة المناسبة

### 3. بدء مكالمة (call_initiated)
```json
{
  "event": "call_initiated",
  "data": {
    "call_id": "CALL_1234567890",
    "customer_id": "12345",
    "phone": "+966566100095",
    "scheduled_time": "2025-01-26T15:30:00Z"
  }
}
```

**النتيجة:**
- تسجيل بدء المكالمة في الأنشطة
- تتبع المكالمات المجدولة

### 4. رسالة صوتية (voice_message)
```json
{
  "event": "voice_message",
  "data": {
    "message_id": "MSG_1234567890",
    "customer_id": "12345",
    "phone": "+966566100095",
    "transcript": "أريد معرفة المزيد عن خدماتكم",
    "sentiment": "positive",
    "keywords": ["خدمات", "معلومات", "اهتمام"]
  }
}
```

**النتيجة:**
- تسجيل الرسالة الصوتية في الأنشطة
- تحليل المشاعر وتحديث احتمالية النجاح
- استخراج الكلمات المفتاحية للمتابعة

## منطق الأعمال

### تحديث احتمالية النجاح

#### بناءً على نتائج المكالمات:
- **مهتم (interested)**: +20% (حد أقصى 90%)
- **غير مهتم (not_interested)**: -30% (حد أدنى 10%)
- **طلب إعادة اتصال (callback_requested)**: +10%
- **لا يوجد رد (no_answer)**: لا تغيير
- **مشغول (busy)**: لا تغيير

#### بناءً على تحليل المشاعر:
- **إيجابي (positive)**: +15% (حد أقصى 95%)
- **سلبي (negative)**: -20% (حد أدنى 5%)
- **محايد (neutral)**: لا تغيير

### إدارة مراحل المبيعات

#### التحديث التلقائي للمراحل:
- **عميل جديد**: مرحلة "prospecting"
- **مكالمة ناجحة**: انتقال إلى "qualification"
- **اهتمام مؤكد**: انتقال إلى "proposal"

## أمثلة عملية

### مثال 1: ربط نظام VoIP مع Python

```python
import requests

api_key = "siyadah_voip_api_key_2025_v1"
url = "https://your-replit-domain.replit.app/api/external/webhook/your_system"

headers = {
    "X-API-Key": api_key,
    "Content-Type": "application/json"
}

# تحديث بيانات عميل
data = {
    "event": "customer_update",
    "data": {
        "customer_id": "12345",
        "name": "عبدالرحمن",
        "phone": "+966566100095",
        "status": "active"
    }
}

response = requests.post(url, headers=headers, json=data)
print(response.json())
```

### مثال 2: تسجيل مكالمة مكتملة

```python
# تسجيل مكالمة مكتملة
call_data = {
    "event": "call_completed",
    "data": {
        "call_id": "CALL_1234567890",
        "customer_id": "12345",
        "phone": "+966566100095",
        "duration": 180,
        "outcome": "interested",
        "notes": "العميل مهتم بحلول الذكاء الاصطناعي للمطاعم"
    }
}

response = requests.post(url, headers=headers, json=call_data)
print(response.json())
```

### مثال 3: Node.js Integration

```javascript
const axios = require('axios');

const config = {
    apiKey: 'siyadah_voip_api_key_2025_v1',
    baseUrl: 'https://your-replit-domain.replit.app'
};

async function sendCustomerUpdate(customerData) {
    try {
        const response = await axios.post(
            `${config.baseUrl}/api/external/webhook/your_system`,
            {
                event: 'customer_update',
                data: customerData
            },
            {
                headers: {
                    'X-API-Key': config.apiKey,
                    'Content-Type': 'application/json'
                }
            }
        );
        
        console.log('تم إرسال تحديث العميل بنجاح:', response.data);
        return response.data;
    } catch (error) {
        console.error('خطأ في إرسال التحديث:', error.response?.data || error.message);
        throw error;
    }
}

// استخدام الدالة
sendCustomerUpdate({
    customer_id: '12345',
    name: 'فاطمة العتيبي',
    phone: '+966551234567',
    email: 'fatima@example.com',
    status: 'active'
});
```

## واجهة الاختبار

تم إنشاء واجهة اختبار شاملة متاحة على المسار `/voip-integration` تشمل:

### 1. لوحة حالة النظام
- **حالة التكامل**: نشط/غير نشط
- **حالة مفتاح API**: صالح/غير صالح
- **عدد الأنشطة**: إجمالي أنشطة VoIP
- **عدد الفرص**: فرص VoIP المُنشأة

### 2. واجهة اختبار تحديث العملاء
- **نماذج تفاعلية** لإدخال بيانات العملاء
- **توليد بيانات تجريبية** تلقائياً
- **اختبار مباشر** للـ webhook
- **عرض النتائج** في الوقت الفعلي

### 3. واجهة اختبار المكالمات
- **تسجيل تفاصيل المكالمات** (المدة، النتيجة، الملاحظات)
- **اختبار أنواع مختلفة** من نتائج المكالمات
- **مراقبة تحديث احتمالية النجاح** تلقائياً

### 4. عرض الأنشطة الحديثة
- **سجل الأنشطة** من نظام VoIP
- **تفاصيل كل نشاط** مع الوقت والتاريخ
- **ربط الأنشطة بالعملاء** والفرص

## الأمان والموثوقية

### 1. المصادقة
- **مفتاح API إلزامي** لجميع الطلبات
- **التحقق من صحة المفتاح** قبل معالجة البيانات
- **رفض الطلبات غير المصرح بها** مع رسالة خطأ واضحة

### 2. معالجة الأخطاء
- **Try-catch شامل** لجميع العمليات
- **تسجيل مفصل للأخطاء** في سجل الخادم
- **رسائل خطأ واضحة** للعملاء
- **استمرارية الخدمة** حتى مع فشل بعض العمليات

### 3. التحقق من البيانات
- **فحص صحة البيانات** قبل المعالجة
- **التحقق من وجود الحقول المطلوبة**
- **تنظيف البيانات** من المحتوى الضار

## مراقبة الأداء

### مؤشرات الأداء الرئيسية

1. **عدد الطلبات الناجحة**: إجمالي العمليات المكتملة بنجاح
2. **معدل الخطأ**: نسبة الطلبات الفاشلة
3. **وقت الاستجابة**: متوسط وقت معالجة الطلبات
4. **عدد العملاء المُضافين**: العملاء الجدد من VoIP
5. **عدد الفرص المُنشأة**: الفرص المُضافة تلقائياً

### تقارير التكامل

```json
{
  "success": true,
  "status": "active",
  "api_key_status": "valid",
  "integration_stats": {
    "total_voip_activities": 45,
    "total_voip_opportunities": 12,
    "last_activity": "2025-01-26T15:30:00Z"
  },
  "recent_activities": [
    {
      "id": 1,
      "type": "customer_update",
      "description": "تم تحديث بيانات العميل عبدالرحمن",
      "timestamp": "2025-01-26T15:30:00Z",
      "userId": "voip_system"
    }
  ],
  "voip_opportunities": [
    {
      "id": 123,
      "name": "عميل VoIP - عبدالرحمن",
      "phone": "+966566100095",
      "probability": 75,
      "stage": "qualification",
      "value": 25000
    }
  ]
}
```

## استكشاف الأخطاء وحلها

### الأخطاء الشائعة

#### 1. خطأ المصادقة (401 Unauthorized)
**السبب**: مفتاح API غير صحيح أو مفقود
**الحل**: التأكد من إرسال Header صحيح:
```
X-API-Key: siyadah_voip_api_key_2025_v1
```

#### 2. خطأ في البيانات (400 Bad Request)
**السبب**: بيانات غير مكتملة أو غير صحيحة
**الحل**: التأكد من إرسال جميع الحقول المطلوبة

#### 3. خطأ الخادم (500 Internal Server Error)
**السبب**: خطأ في معالجة البيانات
**الحل**: مراجعة سجل الخادم وإعادة المحاولة

### نصائح التحسين

1. **إرسال الطلبات بشكل متسلسل** لتجنب التحميل الزائد
2. **التحقق من صحة البيانات** قبل الإرسال
3. **استخدام retry logic** للطلبات الفاشلة
4. **مراقبة أداء النظام** بانتظام

## الخطوات التالية

### تطوير مستقبلي

1. **تكامل ثنائي الاتجاه**: إرسال بيانات من Siyadah AI إلى VoIP
2. **تحليلات متقدمة**: إحصائيات مفصلة عن أداء المكالمات
3. **أتمتة المتابعة**: جدولة المكالمات التلقائية بناءً على البيانات
4. **تكامل مع أنظمة CRM أخرى**: ربط مع المزيد من الأنظمة

### دعم اللغات

- **العربية**: دعم كامل للمحتوى العربي
- **الإنجليزية**: دعم ثانوي للمحتوى الإنجليزي
- **لهجات عربية**: دعم اللهجات المحلية المختلفة

---

## الدعم الفني

للحصول على المساعدة أو الإبلاغ عن المشاكل:
- **البريد الإلكتروني**: support@siyadah.ai
- **الهاتف**: +966500000000
- **الدعم الفني**: متاح 24/7

تم إنشاء هذا الدليل في 26 يناير 2025
الإصدار: 1.0
آخر تحديث: 26 يناير 2025
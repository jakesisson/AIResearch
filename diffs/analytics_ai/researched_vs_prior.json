{
  "project": "Research Data/analytics_ai",
  "repo": "canoekuro/analytics_ai",
  "prior_commit": "14c09b32e8384087c2b1747eab89c92556630661",
  "researched_commit": "8e53e7f5ef5ac140549db4b40eb2e299ddaad4a1",
  "compare_url": "https://github.com/canoekuro/analytics_ai/compare/14c09b32e8384087c2b1747eab89c92556630661...8e53e7f5ef5ac140549db4b40eb2e299ddaad4a1",
  "ahead_by": 1,
  "behind_by": 0,
  "changed_files": [
    {
      "path": "files/backend_codes.py",
      "status": "modified",
      "additions": 194,
      "deletions": 74,
      "patch": "@@ -21,6 +21,8 @@\n import seaborn as sns\n from langchain_google_genai import GoogleGenerativeAIEmbeddings, ChatGoogleGenerativeAI\n import json # import json\u3092\u5148\u982d\u306b\u79fb\u52d5\u3057\u307e\u3057\u305f\n+import google.generativeai as genai # Gemini API \u306e\u30a4\u30f3\u30dd\u30fc\u30c8\n+from google.api_core import exceptions as google_exceptions # Google API\u30a8\u30e9\u30fc\u51e6\u7406\u7528\n \n # \u57fa\u672c\u7684\u306a\u30ed\u30ae\u30f3\u30b0\u3092\u8a2d\u5b9a\n logging.basicConfig(level=logging.INFO)\n@@ -34,7 +36,7 @@\n vectorstore_queries = FAISS.load_local(\"faiss_queries\", embeddings, allow_dangerous_deserialization=True)\n \n # \u74b0\u5883\u5909\u6570\u304b\u3089LLM\u30e2\u30c7\u30eb\u540d\u3092\u53d6\u5f97\u3057\u307e\u3059\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u3042\u308a\uff09\n-llm_model_name = os.getenv(\"LLM_MODEL_NAME\", \"gemini-2.0-flash-lite\")\n+llm_model_name = os.getenv(\"LLM_MODEL_NAME\", \"gemini-1.5-pro\") # \u30c7\u30d5\u30a9\u30eb\u30c8\u3092gemini-1.5-pro\u306b\u5909\u66f4\n \n llm = ChatGoogleGenerativeAI(\n     model=llm_model_name,\n@@ -152,92 +154,210 @@ def clear_data_node(state: MyState):\n def create_analysis_plan_node(state: MyState) -> MyState:\n     user_query = state.get(\"input\", \"\")\n     user_clarification = state.get(\"user_clarification\")\n-\n-    # \u30e2\u30c3\u30ad\u30f3\u30b0\u6226\u7565\n-    mock_plan = []\n-    plan_json_str = \"\"\n     intent_list = state.get(\"intent_list\", [])\n+    parsed_plan = None # \u521d\u671f\u5316\n \n-    if user_clarification:\n-        original_query_for_llm = state.get(\"complex_analysis_original_query\", user_query)\n-        mock_plan = [\n-            {\"action\": \"check_history\", \"details\": [\"clarified sales data\"]},\n-            {\"action\": \"sql\", \"details\": \"clarified sales data\"},\n-            {\"action\": \"interpret\", \"details\": \"interpret clarified sales data\"}\n-        ]\n-    elif \"\u30c7\u30fc\u30bf\u52a0\u5de5\" in intent_list:\n-        mock_plan = [{\"action\": \"data_processing\", \"details\": user_query}]\n-    elif \"ambiguous\" in user_query.lower() or \"vague\" in user_query.lower():\n-        mock_plan = [{\"action\": \"clarify\", \"details\": \"Could you please specify the time period for the sales data?\"}]\n-    elif \"show sales then chart it\" in user_query.lower():\n-        mock_plan = [\n-            {\"action\": \"check_history\", \"details\": [\"sales data\"]},\n-            {\"action\": \"sql\", \"details\": \"sales data\"},\n-            {\"action\": \"chart\", \"details\": \"chart sales data\"}\n-        ]\n-    elif \"show sales\" in user_query.lower() or \"interpret data\" in user_query.lower():\n-        data_req = \"sales data\" if \"sales\" in user_query.lower() else \"general data\"\n-        mock_plan = [\n-            {\"action\": \"check_history\", \"details\": [data_req]},\n-            {\"action\": \"sql\", \"details\": data_req},\n-            {\"action\": \"interpret\", \"details\": f\"interpret {data_req}\"}\n-        ]\n-    elif \"hello\" in user_query.lower() or \"hi\" in user_query.lower():\n-        mock_plan = []\n-    else:\n-        mock_plan = [\n-            {\"action\": \"check_history\", \"details\": [\"general data from query\"]},\n-            {\"action\": \"sql\", \"details\": \"general data from query\"},\n-            {\"action\": \"interpret\", \"details\": \"interpret general data from query\"}\n+    try:\n+        # Gemini\u30e2\u30c7\u30eb\u306e\u521d\u671f\u5316\n+        model_name_for_genai = \"gemini-1.5-pro\"\n+        model = genai.GenerativeModel(model_name_for_genai)\n+        genai.configure(api_key=google_api_key)\n+\n+        # \u30c4\u30fc\u30eb\u306e\u30b9\u30ad\u30fc\u30de\u5b9a\u7fa9\n+        plan_generation_tool = genai.types.Tool(\n+        function_declarations=[\n+            genai.types.FunctionDeclaration(\n+                name=\"create_plan\",\n+                description=\"\u30e6\u30fc\u30b6\u30fc\u306e\u8981\u6c42\u306b\u57fa\u3065\u3044\u3066\u5206\u6790\u8a08\u753b\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\",\n+                parameters=genai.types.Schema(\n+                    type=genai.types.Type.OBJECT,\n+                    properties={\n+                        \"plan_steps\": genai.types.Schema(\n+                            type=genai.types.Type.ARRAY,\n+                            items=genai.types.Schema(\n+                                type=genai.types.Type.OBJECT,\n+                                properties={\n+                                    \"action\": genai.types.Schema(\n+                                        type=genai.types.Type.STRING,\n+                                        description=\"\u5b9f\u884c\u3059\u308b\u30a2\u30af\u30b7\u30e7\u30f3\uff08clarify, check_history, sql, chart, interpret, data_processing\uff09\"\n+                                    ),\n+                                    \"details\": genai.types.Schema(\n+                                        type=genai.types.Type.ANY, # string or array of strings\n+                                        description=\"\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u8a73\u7d30\u3002clarify\u3068sql\u306f\u6587\u5b57\u5217\u3001check_history\u306f\u6587\u5b57\u5217\u306e\u914d\u5217\u3002\"\n+                                    )\n+                                },\n+                                required=[\"action\", \"details\"]\n+                            )\n+                        )\n+                    },\n+                    required=[\"plan_steps\"]\n+                )\n+            )\n         ]\n+        )\n \n-    try:\n-        plan_json_str = json.dumps(mock_plan)\n-    except Exception as e:\n-        logging.error(f\"mock_plan\u306eJSON\u3078\u306e\u30b7\u30ea\u30a2\u30eb\u5316\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f: {e}\")\n-        return {\n-            **state,\n-            \"analysis_plan\": None,\n-            \"current_plan_step_index\": None,\n-            \"user_clarification\": None,\n-            \"condition\": \"plan_generation_failed\",\n-            \"error\": f\"\u5206\u6790\u8a08\u753b\u306e\u4fdd\u5b58\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002: {e}\"\n-        }\n+        SYSTEM_PROMPT = \"\"\"\u3042\u306a\u305f\u306fAI\u30c7\u30fc\u30bf\u30a2\u30ca\u30ea\u30b9\u30c8\u3067\u3059\u3002\u30e6\u30fc\u30b6\u30fc\u306e\u8981\u6c42\u3092\u5206\u6790\u3057\u3001\u30b9\u30c6\u30c3\u30d7\u30d0\u30a4\u30b9\u30c6\u30c3\u30d7\u306e\u5206\u6790\u8a08\u753b\u3092\u4f5c\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n+\u5229\u7528\u53ef\u80fd\u306a\u30a2\u30af\u30b7\u30e7\u30f3\u306f\u6b21\u306e\u3068\u304a\u308a\u3067\u3059:\n+- clarify: \u30e6\u30fc\u30b6\u30fc\u306b\u8a73\u7d30\u3092\u8cea\u554f\u3057\u307e\u3059\u3002 (\u4f8b: \"\u671f\u9593\u306e\u6307\u5b9a\u3092\u6c42\u3081\u308b\")\n+  - \"details\": (string) \u30e6\u30fc\u30b6\u30fc\u3078\u306e\u8cea\u554f\u6587\u3002\n+- check_history: \u904e\u53bb\u306b\u540c\u69d8\u306e\u30c7\u30fc\u30bf\u304c\u53d6\u5f97\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002 (\u4f8b: \"'\u6708\u6b21\u58f2\u4e0a\u30c7\u30fc\u30bf'\u3092\u78ba\u8a8d\")\n+  - \"details\": (array of strings) \u78ba\u8a8d\u3059\u308b\u30c7\u30fc\u30bf\u8981\u4ef6\u306e\u30ea\u30b9\u30c8\u3002\n+- sql: \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002 (\u4f8b: \"'\u7279\u5b9a\u306e\u88fd\u54c1\u306e\u58f2\u4e0a\u30c7\u30fc\u30bf\u3092\u53d6\u5f97'\")\n+  - \"details\": (string) SQL\u3067\u53d6\u5f97\u3059\u308b\u5177\u4f53\u7684\u306a\u30c7\u30fc\u30bf\u306e\u5185\u5bb9\u3002\n+- chart: \u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u304b\u3089\u30b0\u30e9\u30d5\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002 (\u4f8b: \"'\u58f2\u4e0a\u30c7\u30fc\u30bf\u3092\u68d2\u30b0\u30e9\u30d5\u3067\u8868\u793a'\")\n+  - \"details\": (string) \u30b0\u30e9\u30d5\u4f5c\u6210\u306e\u6307\u793a (\u4f8b: \"\u58f2\u4e0a\u30c7\u30fc\u30bf\u3092\u68d2\u30b0\u30e9\u30d5\u3067\u8868\u793a\", \"DF_KEY['\u58f2\u4e0a\u30c7\u30fc\u30bf'] \u3092\u4f7f\u7528\u3057\u3066\u6642\u7cfb\u5217\u30b0\u30e9\u30d5\u3092\u4f5c\u6210\")\u3002\n+- interpret: \u30c7\u30fc\u30bf\u3084\u30b0\u30e9\u30d5\u3092\u89e3\u91c8\u3057\u3001\u6d1e\u5bdf\u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002 (\u4f8b: \"'\u58f2\u4e0a\u50be\u5411\u3092\u5206\u6790\u3059\u308b'\")\n+  - \"details\": (string) \u89e3\u91c8\u306e\u7126\u70b9\u3084\u5185\u5bb9\u3002\n+- data_processing: \u65e2\u5b58\u306e\u30c7\u30fc\u30bf\u3092\u52a0\u5de5\u30fb\u5909\u63db\u3057\u307e\u3059\u3002 (\u4f8b: \"'\u58f2\u4e0a\u30c7\u30fc\u30bf\u306b\u5229\u76ca\u7387\u5217\u3092\u8ffd\u52a0\u3059\u308b'\")\n+  - \"details\": (string) \u30c7\u30fc\u30bf\u52a0\u5de5\u306e\u5177\u4f53\u7684\u306a\u6307\u793a\u3002\u51e6\u7406\u5bfe\u8c61\u306eDataFrame\u3092\u6307\u5b9a\u3059\u308b\u306b\u306f `DF_KEY['your_dataframe_key_in_latest_df']` \u3092\u542b\u3081\u3066\u304f\u3060\u3055\u3044\u3002\n+\n+\u4ee5\u4e0b\u306f\u8a08\u753b\u4f5c\u6210\u306e\u4f8b\u3067\u3059:\n+\n+\u4f8b1: \u66d6\u6627\u306a\u30ea\u30af\u30a8\u30b9\u30c8\n+\u30e6\u30fc\u30b6\u30fc\u306e\u30af\u30a8\u30ea: \"Show me sales data.\"\n+\u751f\u6210\u3055\u308c\u308b\u30d7\u30e9\u30f3:\n+```json\n+[\n+  {\"action\": \"clarify\", \"details\": \"Could you please specify the time period for the sales data (e.g., last month, last quarter)?\"}\n+]\n+```\n+\n+\u4f8b2: \u8907\u6570\u30b9\u30c6\u30c3\u30d7\u306e\u30ea\u30af\u30a8\u30b9\u30c8\n+\u30e6\u30fc\u30b6\u30fc\u306e\u30af\u30a8\u30ea: \"Get the total sales for product X last month, then visualize it as a bar chart, and finally interpret the chart.\"\n+\u751f\u6210\u3055\u308c\u308b\u30d7\u30e9\u30f3:\n+```json\n+[\n+  {\"action\": \"check_history\", \"details\": [\"total sales for product X last month\"]},\n+  {\"action\": \"sql\", \"details\": \"total sales for product X last month\"},\n+  {\"action\": \"chart\", \"details\": \"bar chart of total sales for product X last month\"},\n+  {\"action\": \"interpret\", \"details\": \"interpret the bar chart of total sales for product X last month\"}\n+]\n+```\n+\n+\u4f8b3: \u30c7\u30fc\u30bf\u52a0\u5de5\u3092\u542b\u3080\u30ea\u30af\u30a8\u30b9\u30c8\n+\u30e6\u30fc\u30b6\u30fc\u306e\u30af\u30a8\u30ea: \"Load the customer dataset, then add a new column 'age_group' based on the 'age' column (e.g., <18: Teen, 18-65: Adult, >65: Senior), and show the first 5 rows of the processed data.\"\n+\u751f\u6210\u3055\u308c\u308b\u30d7\u30e9\u30f3:\n+```json\n+[\n+  {\"action\": \"check_history\", \"details\": [\"customer dataset\"]},\n+  {\"action\": \"sql\", \"details\": \"customer dataset\"},\n+  {\"action\": \"data_processing\", \"details\": \"Add a new column 'age_group' to DF_KEY['customer dataset'] based on the 'age' column (e.g., <18: Teen, 18-65: Adult, >65: Senior)\"},\n+  {\"action\": \"interpret\", \"details\": \"Describe the first 5 rows of the processed customer dataset (DF_KEY['customer dataset']) including the new 'age_group' column.\"}\n+]\n+```\n+\n+\u5fc5\u305aJSON\u5f62\u5f0f\u3067 plan_steps \u3092\u542b\u3080\u5fdc\u7b54\u3092\u751f\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n+\"\"\"\n+        prompt_parts = [SYSTEM_PROMPT]\n+\n+        # Add query history to prompt\n+        query_history = state.get(\"query_history\", [])\n+        MAX_HISTORY_LEN = 5 # \u6700\u5927\u5c65\u6b74\u6570\n+        if query_history:\n+            history_start_index = max(0, len(query_history) - MAX_HISTORY_LEN -1) # \u73fe\u5728\u306e\u30af\u30a8\u30ea\u306f\u9664\u304f\u305f\u3081-1\n+            relevant_history = query_history[history_start_index:-1] if len(query_history) > 1 else []\n+            if relevant_history:\n+                formatted_history = \"\\n\\n\u904e\u53bb\u306e\u95a2\u9023\u3059\u308b\u554f\u3044\u5408\u308f\u305b\u5c65\u6b74 (\u65b0\u3057\u3044\u3082\u306e\u304c\u6700\u5f8c):\\n\"\n+                for i, hist_item in enumerate(relevant_history):\n+                    formatted_history += f\"- {hist_item}\\n\"\n+                prompt_parts.append(formatted_history)\n+\n+        prompt_parts.append(\"\\n\u30e6\u30fc\u30b6\u30fc\u306e\u73fe\u5728\u306e\u30af\u30a8\u30ea: \")\n+        prompt_parts.append(user_query)\n+\n+        if user_clarification:\n+            prompt_parts.append(f\"\\n\u30e6\u30fc\u30b6\u30fc\u304b\u3089\u306e\u8ffd\u52a0\u60c5\u5831: {user_clarification}\")\n+            original_query = state.get(\"complex_analysis_original_query\", \"\")\n+            if original_query and original_query != user_query :\n+                 prompt_parts.append(f\"\\n(\u3053\u306e\u8ffd\u52a0\u60c5\u5831\u306f\u3001\u4ee5\u524d\u306e\u30af\u30a8\u30ea\u300c{original_query}\u300d\u306b\u95a2\u9023\u3057\u3066\u3044\u307e\u3059)\")\n+\n+        final_prompt_string = \"\".join(prompt_parts)\n+        logging.info(f\"Gemini\u3078\u306e\u6700\u7d42\u30d7\u30ed\u30f3\u30d7\u30c8:\\n{final_prompt_string}\")\n+\n+        # API\u30b3\u30fc\u30eb\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u51e6\u7406\n+        try:\n+            response = model.generate_content(\n+                final_prompt_string,\n+                tools=[plan_generation_tool],\n+                generation_config=genai.types.GenerationConfig(response_mime_type=\"application/json\")\n+            )\n+            logging.info(f\"Gemini\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9: {response}\")\n \n-    parsed_plan = None\n-    try:\n-        parsed_plan = json.loads(plan_json_str)\n-        if not isinstance(parsed_plan, list):\n-            raise ValueError(\"\u5206\u6790\u30d7\u30e9\u30f3\u304c\u30ea\u30b9\u30c8\u578b\u306b\u306a\u3063\u3066\u3044\u307e\u305b\u3093\u3002\")\n-        for step in parsed_plan:\n-            if not isinstance(step, dict) or \"action\" not in step or \"details\" not in step:\n-                raise ValueError(\"\u5206\u6790\u30d7\u30e9\u30f3\u5185\u306e\u5404\u30b9\u30c6\u30c3\u30d7\u304c\u6b63\u3057\u3044\u5f62\u5f0f\u3067\u306f\u3042\u308a\u307e\u305b\u3093\uff08'action'\u3068'details'\u5fc5\u9808\uff09\u3002\")\n-\n-    except (json.JSONDecodeError, ValueError) as e:\n-        logging.error(f\"\u5206\u6790\u8a08\u753b\u306e\u30d1\u30fc\u30b9\u30fb\u691c\u8a3c\u306b\u5931\u6557: {e}. Plan string: '{plan_json_str}'\")\n+            if not response.candidates or not response.candidates[0].content.parts:\n+                raise ValueError(\"Gemini\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u6709\u52b9\u306a\u5019\u88dc\u307e\u305f\u306f\u30d1\u30fc\u30c8\u304c\u3042\u308a\u307e\u305b\u3093\u3002\")\n+\n+            function_call_part = next((part for part in response.candidates[0].content.parts if part.function_call), None)\n+            \n+            if not function_call_part:\n+                raw_text_response = response.text if hasattr(response, 'text') else \"\u5229\u7528\u53ef\u80fd\u306a\u30c6\u30ad\u30b9\u30c8\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u3042\u308a\u307e\u305b\u3093\u3002\"\n+                logging.warning(f\"Gemini\u30ec\u30b9\u30dd\u30f3\u30b9\u306bfunction_call\u304c\u542b\u307e\u308c\u3066\u3044\u307e\u305b\u3093\u3002\u30c6\u30ad\u30b9\u30c8\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8a66\u307f\u307e\u3059: {raw_text_response}\")\n+                try:\n+                    parsed_plan_from_text = json.loads(raw_text_response)\n+                    if not (isinstance(parsed_plan_from_text, list) and \\\n+                       all(isinstance(step, dict) and \"action\" in step and \"details\" in step for step in parsed_plan_from_text)):\n+                        raise ValueError(\"\u30c6\u30ad\u30b9\u30c8\u30ec\u30b9\u30dd\u30f3\u30b9\u306f\u6709\u52b9\u306a\u30d7\u30e9\u30f3\u5f62\u5f0f\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\")\n+                    logging.info(\"Gemini\u304c\u30c6\u30ad\u30b9\u30c8\u5f62\u5f0f\u3067\u6709\u52b9\u306a\u30d7\u30e9\u30f3\u3092\u8fd4\u3057\u307e\u3057\u305f\u3002\u3053\u308c\u3092\u63a1\u7528\u3057\u307e\u3059\u3002\")\n+                    plan_steps = parsed_plan_from_text\n+                except (json.JSONDecodeError, ValueError) as e_text_parse:\n+                    logging.error(f\"Gemini\u306e\u30c6\u30ad\u30b9\u30c8\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u30d1\u30fc\u30b9\u306b\u5931\u6557: {e_text_parse}\")\n+                    raise ValueError(f\"\u30e2\u30c7\u30eb\u5fdc\u7b54\u306f\u671f\u5f85\u3055\u308c\u308bfunction_call\u5f62\u5f0f\u3067\u306f\u306a\u304f\u3001\u30c6\u30ad\u30b9\u30c8\u5fdc\u7b54\u306e\u89e3\u6790\u306b\u3082\u5931\u6557\u3057\u307e\u3057\u305f\u3002\u8a73\u7d30: {e_text_parse}\") from e_text_parse\n+            else:\n+                function_args = function_call_part.function_call.args\n+                if not function_args or \"plan_steps\" not in function_args:\n+                    raise ValueError(\"Gemini\u30ec\u30b9\u30dd\u30f3\u30b9\u306efunction_call.args\u306bplan_steps\u304c\u542b\u307e\u308c\u3066\u3044\u307e\u305b\u3093\u3002\")\n+                plan_steps = function_args[\"plan_steps\"]\n+\n+            if isinstance(plan_steps, str): # plan_steps\u304c\u6587\u5b57\u5217\u3067JSON\u914d\u5217\u3068\u3057\u3066\u30a8\u30f3\u30b3\u30fc\u30c9\u3055\u308c\u3066\u3044\u308b\u5834\u5408\n+                try:\n+                    plan_steps = json.loads(plan_steps)\n+                except json.JSONDecodeError as e_json_str:\n+                    raise ValueError(f\"plan_steps\u306eJSON\u6587\u5b57\u5217\u306e\u30c7\u30b3\u30fc\u30c9\u306b\u5931\u6557: {e_json_str}. \u6587\u5b57\u5217: '{plan_steps}'\")\n+\n+            if not isinstance(plan_steps, list):\n+                raise ValueError(f\"plan_steps\u304c\u30ea\u30b9\u30c8\u5f62\u5f0f\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u578b: {type(plan_steps)}\")\n+\n+            for step in plan_steps: # \u5404\u30b9\u30c6\u30c3\u30d7\u306e\u691c\u8a3c\n+                if not (isinstance(step, dict) and \"action\" in step and \"details\" in step):\n+                    raise ValueError(\"\u5206\u6790\u30d7\u30e9\u30f3\u5185\u306e\u5404\u30b9\u30c6\u30c3\u30d7\u304c\u6b63\u3057\u3044\u5f62\u5f0f\u3067\u306f\u3042\u308a\u307e\u305b\u3093\uff08'action'\u3068'details'\u5fc5\u9808\uff09\u3002\")\n+                allowed_actions = {\"clarify\", \"check_history\", \"sql\", \"chart\", \"interpret\", \"data_processing\"}\n+                if step[\"action\"] not in allowed_actions:\n+                    logging.warning(f\"\u30d7\u30e9\u30f3\u306b\u672a\u77e5\u306e\u30a2\u30af\u30b7\u30e7\u30f3 '{step['action']}' \u304c\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\")\n+            \n+            parsed_plan = plan_steps\n+\n+        except google_exceptions.GoogleAPICallError as e_api:\n+            logging.error(f\"Gemini API\u547c\u3073\u51fa\u3057\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f: {e_api}\", exc_info=True)\n+            return {**state, \"analysis_plan\": None, \"current_plan_step_index\": None, \"user_clarification\": None,\n+                    \"condition\": \"plan_generation_failed\", \"error\": f\"\u5206\u6790\u8a08\u753b\u306e\u4f5c\u6210\u4e2d\u306b\u30e2\u30c7\u30eb\u547c\u3073\u51fa\u3057\u3067\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u7ba1\u7406\u8005\u306b\u3054\u9023\u7d61\u304f\u3060\u3055\u3044\u3002(\u8a73\u7d30: {e_api.message})\"}\n+        except (ValueError, AttributeError, json.JSONDecodeError) as e_parse:\n+            logging.error(f\"Gemini\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u51e6\u7406\u307e\u305f\u306f\u691c\u8a3c\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f: {e_parse}\", exc_info=True)\n+            return {**state, \"analysis_plan\": None, \"current_plan_step_index\": None, \"user_clarification\": None,\n+                    \"condition\": \"plan_generation_failed\", \"error\": f\"\u5206\u6790\u8a08\u753b\u306e\u751f\u6210\u4e2d\u306b\u30e2\u30c7\u30eb\u5fdc\u7b54\u306e\u89e3\u6790\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002\u5f62\u5f0f\u304c\u6b63\u3057\u304f\u306a\u3044\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002(\u8a73\u7d30: {str(e_parse)})\"}\n+\n+    except Exception as e_outer: # \u30e2\u30c7\u30eb\u521d\u671f\u5316\u3084\u30d7\u30ed\u30f3\u30d7\u30c8\u69cb\u7bc9\u306a\u3069\u3001API\u30b3\u30fc\u30eb\u4ee5\u5916\u306e\u90e8\u5206\u3067\u306e\u4e88\u671f\u305b\u306c\u30a8\u30e9\u30fc\n+        logging.error(f\"\u5206\u6790\u8a08\u753b\u4f5c\u6210\u30ce\u30fc\u30c9\u3067\u4e88\u671f\u305b\u306c\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f: {e_outer}\", exc_info=True)\n         return {\n-            **state,\n-            \"analysis_plan\": None,\n-            \"current_plan_step_index\": None,\n-            \"user_clarification\": None,\n-            \"condition\": \"plan_generation_failed\",\n-            \"error\": f\"\u5206\u6790\u8a08\u753b\u306e\u5f62\u5f0f\u3084\u5185\u5bb9\u306b\u4e0d\u5099\u304c\u3042\u308a\u307e\u3059: {e}\"\n+            **state, \"analysis_plan\": None, \"current_plan_step_index\": None, \"user_clarification\": None,\n+            \"condition\": \"plan_generation_failed\", \"error\": f\"\u5206\u6790\u8a08\u753b\u306e\u4f5c\u6210\u4e2d\u306b\u4e88\u671f\u305b\u306c\u30b7\u30b9\u30c6\u30e0\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u7ba1\u7406\u8005\u306b\u3054\u9023\u7d61\u304f\u3060\u3055\u3044\u3002(\u8a73\u7d30: {str(e_outer)})\"\n         }\n-\n+        \n+    # current_input\u306e\u53d6\u5f97\u3068complex_analysis_original_query\u306e\u30ed\u30b8\u30c3\u30af\u306f\u5909\u66f4\u306a\u3057\n     current_input = state.get(\"input\", \"\")\n-    original_query_for_complex = state.get(\"complex_analysis_original_query\", current_input if parsed_plan else None)\n-    if user_clarification and not state.get(\"complex_analysis_original_query\"):\n-        original_query_for_complex = current_input\n-\n+    original_query_for_complex = state.get(\"complex_analysis_original_query\")\n+    if parsed_plan and not original_query_for_complex and \\\n+       (\"clarify\" in [step.get(\"action\") for step in parsed_plan if isinstance(step, dict)] or user_clarification) :\n+        original_query_for_complex = user_query\n+    \n+    # user_clarification \u306f\u3053\u3053\u3067\u6d88\u8cbb\u3055\u308c\u308b\u306e\u3067None\u306b\u3059\u308b\n     return {\n         **state,\n         \"complex_analysis_original_query\": original_query_for_complex,\n-        \"analysis_plan\": parsed_plan,\n+        \"analysis_plan\": parsed_plan, # parsed_plan\u304cNone\u306e\u5834\u5408\u3082\u3042\u308b\uff08\u30a8\u30e9\u30fc\u6642\u306a\u3069\uff09\n         \"current_plan_step_index\": 0 if parsed_plan else None,\n         \"awaiting_step_confirmation\": False,\n-        \"user_clarification\": None,\n-        \"condition\": \"plan_generated\" if parsed_plan else \"empty_plan_generated\",\n-        \"error\": None\n+        \"user_clarification\": None, \n+        \"condition\": \"plan_generated\" if parsed_plan else \"empty_plan_generated\", # \u30a8\u30e9\u30fc\u6642\u306fplan_generation_failed\u304c\u30bb\u30c3\u30c8\u3055\u308c\u3066\u3044\u308b\u306f\u305a\n+        \"error\": state.get(\"error\") # \u30a8\u30e9\u30fc\u6642\u306f\u3053\u3053\u3067\u30bb\u30c3\u30c8\u3055\u308c\u305f\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u7dad\u6301\u3055\u308c\u308b\n     }\n \n #\u5206\u6790\u8a08\u753b\u306b\u57fa\u3065\u3044\u3066\u3001\u30e6\u30fc\u30b6\u30fc\u306b\u8cea\u554f",
      "patch_lines": [
        "@@ -21,6 +21,8 @@\n",
        " import seaborn as sns\n",
        " from langchain_google_genai import GoogleGenerativeAIEmbeddings, ChatGoogleGenerativeAI\n",
        " import json # import json\u3092\u5148\u982d\u306b\u79fb\u52d5\u3057\u307e\u3057\u305f\n",
        "+import google.generativeai as genai # Gemini API \u306e\u30a4\u30f3\u30dd\u30fc\u30c8\n",
        "+from google.api_core import exceptions as google_exceptions # Google API\u30a8\u30e9\u30fc\u51e6\u7406\u7528\n",
        " \n",
        " # \u57fa\u672c\u7684\u306a\u30ed\u30ae\u30f3\u30b0\u3092\u8a2d\u5b9a\n",
        " logging.basicConfig(level=logging.INFO)\n",
        "@@ -34,7 +36,7 @@\n",
        " vectorstore_queries = FAISS.load_local(\"faiss_queries\", embeddings, allow_dangerous_deserialization=True)\n",
        " \n",
        " # \u74b0\u5883\u5909\u6570\u304b\u3089LLM\u30e2\u30c7\u30eb\u540d\u3092\u53d6\u5f97\u3057\u307e\u3059\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u5024\u3042\u308a\uff09\n",
        "-llm_model_name = os.getenv(\"LLM_MODEL_NAME\", \"gemini-2.0-flash-lite\")\n",
        "+llm_model_name = os.getenv(\"LLM_MODEL_NAME\", \"gemini-1.5-pro\") # \u30c7\u30d5\u30a9\u30eb\u30c8\u3092gemini-1.5-pro\u306b\u5909\u66f4\n",
        " \n",
        " llm = ChatGoogleGenerativeAI(\n",
        "     model=llm_model_name,\n",
        "@@ -152,92 +154,210 @@ def clear_data_node(state: MyState):\n",
        " def create_analysis_plan_node(state: MyState) -> MyState:\n",
        "     user_query = state.get(\"input\", \"\")\n",
        "     user_clarification = state.get(\"user_clarification\")\n",
        "-\n",
        "-    # \u30e2\u30c3\u30ad\u30f3\u30b0\u6226\u7565\n",
        "-    mock_plan = []\n",
        "-    plan_json_str = \"\"\n",
        "     intent_list = state.get(\"intent_list\", [])\n",
        "+    parsed_plan = None # \u521d\u671f\u5316\n",
        " \n",
        "-    if user_clarification:\n",
        "-        original_query_for_llm = state.get(\"complex_analysis_original_query\", user_query)\n",
        "-        mock_plan = [\n",
        "-            {\"action\": \"check_history\", \"details\": [\"clarified sales data\"]},\n",
        "-            {\"action\": \"sql\", \"details\": \"clarified sales data\"},\n",
        "-            {\"action\": \"interpret\", \"details\": \"interpret clarified sales data\"}\n",
        "-        ]\n",
        "-    elif \"\u30c7\u30fc\u30bf\u52a0\u5de5\" in intent_list:\n",
        "-        mock_plan = [{\"action\": \"data_processing\", \"details\": user_query}]\n",
        "-    elif \"ambiguous\" in user_query.lower() or \"vague\" in user_query.lower():\n",
        "-        mock_plan = [{\"action\": \"clarify\", \"details\": \"Could you please specify the time period for the sales data?\"}]\n",
        "-    elif \"show sales then chart it\" in user_query.lower():\n",
        "-        mock_plan = [\n",
        "-            {\"action\": \"check_history\", \"details\": [\"sales data\"]},\n",
        "-            {\"action\": \"sql\", \"details\": \"sales data\"},\n",
        "-            {\"action\": \"chart\", \"details\": \"chart sales data\"}\n",
        "-        ]\n",
        "-    elif \"show sales\" in user_query.lower() or \"interpret data\" in user_query.lower():\n",
        "-        data_req = \"sales data\" if \"sales\" in user_query.lower() else \"general data\"\n",
        "-        mock_plan = [\n",
        "-            {\"action\": \"check_history\", \"details\": [data_req]},\n",
        "-            {\"action\": \"sql\", \"details\": data_req},\n",
        "-            {\"action\": \"interpret\", \"details\": f\"interpret {data_req}\"}\n",
        "-        ]\n",
        "-    elif \"hello\" in user_query.lower() or \"hi\" in user_query.lower():\n",
        "-        mock_plan = []\n",
        "-    else:\n",
        "-        mock_plan = [\n",
        "-            {\"action\": \"check_history\", \"details\": [\"general data from query\"]},\n",
        "-            {\"action\": \"sql\", \"details\": \"general data from query\"},\n",
        "-            {\"action\": \"interpret\", \"details\": \"interpret general data from query\"}\n",
        "+    try:\n",
        "+        # Gemini\u30e2\u30c7\u30eb\u306e\u521d\u671f\u5316\n",
        "+        model_name_for_genai = \"gemini-1.5-pro\"\n",
        "+        model = genai.GenerativeModel(model_name_for_genai)\n",
        "+        genai.configure(api_key=google_api_key)\n",
        "+\n",
        "+        # \u30c4\u30fc\u30eb\u306e\u30b9\u30ad\u30fc\u30de\u5b9a\u7fa9\n",
        "+        plan_generation_tool = genai.types.Tool(\n",
        "+        function_declarations=[\n",
        "+            genai.types.FunctionDeclaration(\n",
        "+                name=\"create_plan\",\n",
        "+                description=\"\u30e6\u30fc\u30b6\u30fc\u306e\u8981\u6c42\u306b\u57fa\u3065\u3044\u3066\u5206\u6790\u8a08\u753b\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002\",\n",
        "+                parameters=genai.types.Schema(\n",
        "+                    type=genai.types.Type.OBJECT,\n",
        "+                    properties={\n",
        "+                        \"plan_steps\": genai.types.Schema(\n",
        "+                            type=genai.types.Type.ARRAY,\n",
        "+                            items=genai.types.Schema(\n",
        "+                                type=genai.types.Type.OBJECT,\n",
        "+                                properties={\n",
        "+                                    \"action\": genai.types.Schema(\n",
        "+                                        type=genai.types.Type.STRING,\n",
        "+                                        description=\"\u5b9f\u884c\u3059\u308b\u30a2\u30af\u30b7\u30e7\u30f3\uff08clarify, check_history, sql, chart, interpret, data_processing\uff09\"\n",
        "+                                    ),\n",
        "+                                    \"details\": genai.types.Schema(\n",
        "+                                        type=genai.types.Type.ANY, # string or array of strings\n",
        "+                                        description=\"\u30a2\u30af\u30b7\u30e7\u30f3\u306e\u8a73\u7d30\u3002clarify\u3068sql\u306f\u6587\u5b57\u5217\u3001check_history\u306f\u6587\u5b57\u5217\u306e\u914d\u5217\u3002\"\n",
        "+                                    )\n",
        "+                                },\n",
        "+                                required=[\"action\", \"details\"]\n",
        "+                            )\n",
        "+                        )\n",
        "+                    },\n",
        "+                    required=[\"plan_steps\"]\n",
        "+                )\n",
        "+            )\n",
        "         ]\n",
        "+        )\n",
        " \n",
        "-    try:\n",
        "-        plan_json_str = json.dumps(mock_plan)\n",
        "-    except Exception as e:\n",
        "-        logging.error(f\"mock_plan\u306eJSON\u3078\u306e\u30b7\u30ea\u30a2\u30eb\u5316\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f: {e}\")\n",
        "-        return {\n",
        "-            **state,\n",
        "-            \"analysis_plan\": None,\n",
        "-            \"current_plan_step_index\": None,\n",
        "-            \"user_clarification\": None,\n",
        "-            \"condition\": \"plan_generation_failed\",\n",
        "-            \"error\": f\"\u5206\u6790\u8a08\u753b\u306e\u4fdd\u5b58\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002: {e}\"\n",
        "-        }\n",
        "+        SYSTEM_PROMPT = \"\"\"\u3042\u306a\u305f\u306fAI\u30c7\u30fc\u30bf\u30a2\u30ca\u30ea\u30b9\u30c8\u3067\u3059\u3002\u30e6\u30fc\u30b6\u30fc\u306e\u8981\u6c42\u3092\u5206\u6790\u3057\u3001\u30b9\u30c6\u30c3\u30d7\u30d0\u30a4\u30b9\u30c6\u30c3\u30d7\u306e\u5206\u6790\u8a08\u753b\u3092\u4f5c\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n",
        "+\u5229\u7528\u53ef\u80fd\u306a\u30a2\u30af\u30b7\u30e7\u30f3\u306f\u6b21\u306e\u3068\u304a\u308a\u3067\u3059:\n",
        "+- clarify: \u30e6\u30fc\u30b6\u30fc\u306b\u8a73\u7d30\u3092\u8cea\u554f\u3057\u307e\u3059\u3002 (\u4f8b: \"\u671f\u9593\u306e\u6307\u5b9a\u3092\u6c42\u3081\u308b\")\n",
        "+  - \"details\": (string) \u30e6\u30fc\u30b6\u30fc\u3078\u306e\u8cea\u554f\u6587\u3002\n",
        "+- check_history: \u904e\u53bb\u306b\u540c\u69d8\u306e\u30c7\u30fc\u30bf\u304c\u53d6\u5f97\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u307e\u3059\u3002 (\u4f8b: \"'\u6708\u6b21\u58f2\u4e0a\u30c7\u30fc\u30bf'\u3092\u78ba\u8a8d\")\n",
        "+  - \"details\": (array of strings) \u78ba\u8a8d\u3059\u308b\u30c7\u30fc\u30bf\u8981\u4ef6\u306e\u30ea\u30b9\u30c8\u3002\n",
        "+- sql: \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u304b\u3089\u30c7\u30fc\u30bf\u3092\u53d6\u5f97\u3057\u307e\u3059\u3002 (\u4f8b: \"'\u7279\u5b9a\u306e\u88fd\u54c1\u306e\u58f2\u4e0a\u30c7\u30fc\u30bf\u3092\u53d6\u5f97'\")\n",
        "+  - \"details\": (string) SQL\u3067\u53d6\u5f97\u3059\u308b\u5177\u4f53\u7684\u306a\u30c7\u30fc\u30bf\u306e\u5185\u5bb9\u3002\n",
        "+- chart: \u53d6\u5f97\u3057\u305f\u30c7\u30fc\u30bf\u304b\u3089\u30b0\u30e9\u30d5\u3092\u4f5c\u6210\u3057\u307e\u3059\u3002 (\u4f8b: \"'\u58f2\u4e0a\u30c7\u30fc\u30bf\u3092\u68d2\u30b0\u30e9\u30d5\u3067\u8868\u793a'\")\n",
        "+  - \"details\": (string) \u30b0\u30e9\u30d5\u4f5c\u6210\u306e\u6307\u793a (\u4f8b: \"\u58f2\u4e0a\u30c7\u30fc\u30bf\u3092\u68d2\u30b0\u30e9\u30d5\u3067\u8868\u793a\", \"DF_KEY['\u58f2\u4e0a\u30c7\u30fc\u30bf'] \u3092\u4f7f\u7528\u3057\u3066\u6642\u7cfb\u5217\u30b0\u30e9\u30d5\u3092\u4f5c\u6210\")\u3002\n",
        "+- interpret: \u30c7\u30fc\u30bf\u3084\u30b0\u30e9\u30d5\u3092\u89e3\u91c8\u3057\u3001\u6d1e\u5bdf\u3092\u63d0\u4f9b\u3057\u307e\u3059\u3002 (\u4f8b: \"'\u58f2\u4e0a\u50be\u5411\u3092\u5206\u6790\u3059\u308b'\")\n",
        "+  - \"details\": (string) \u89e3\u91c8\u306e\u7126\u70b9\u3084\u5185\u5bb9\u3002\n",
        "+- data_processing: \u65e2\u5b58\u306e\u30c7\u30fc\u30bf\u3092\u52a0\u5de5\u30fb\u5909\u63db\u3057\u307e\u3059\u3002 (\u4f8b: \"'\u58f2\u4e0a\u30c7\u30fc\u30bf\u306b\u5229\u76ca\u7387\u5217\u3092\u8ffd\u52a0\u3059\u308b'\")\n",
        "+  - \"details\": (string) \u30c7\u30fc\u30bf\u52a0\u5de5\u306e\u5177\u4f53\u7684\u306a\u6307\u793a\u3002\u51e6\u7406\u5bfe\u8c61\u306eDataFrame\u3092\u6307\u5b9a\u3059\u308b\u306b\u306f `DF_KEY['your_dataframe_key_in_latest_df']` \u3092\u542b\u3081\u3066\u304f\u3060\u3055\u3044\u3002\n",
        "+\n",
        "+\u4ee5\u4e0b\u306f\u8a08\u753b\u4f5c\u6210\u306e\u4f8b\u3067\u3059:\n",
        "+\n",
        "+\u4f8b1: \u66d6\u6627\u306a\u30ea\u30af\u30a8\u30b9\u30c8\n",
        "+\u30e6\u30fc\u30b6\u30fc\u306e\u30af\u30a8\u30ea: \"Show me sales data.\"\n",
        "+\u751f\u6210\u3055\u308c\u308b\u30d7\u30e9\u30f3:\n",
        "+```json\n",
        "+[\n",
        "+  {\"action\": \"clarify\", \"details\": \"Could you please specify the time period for the sales data (e.g., last month, last quarter)?\"}\n",
        "+]\n",
        "+```\n",
        "+\n",
        "+\u4f8b2: \u8907\u6570\u30b9\u30c6\u30c3\u30d7\u306e\u30ea\u30af\u30a8\u30b9\u30c8\n",
        "+\u30e6\u30fc\u30b6\u30fc\u306e\u30af\u30a8\u30ea: \"Get the total sales for product X last month, then visualize it as a bar chart, and finally interpret the chart.\"\n",
        "+\u751f\u6210\u3055\u308c\u308b\u30d7\u30e9\u30f3:\n",
        "+```json\n",
        "+[\n",
        "+  {\"action\": \"check_history\", \"details\": [\"total sales for product X last month\"]},\n",
        "+  {\"action\": \"sql\", \"details\": \"total sales for product X last month\"},\n",
        "+  {\"action\": \"chart\", \"details\": \"bar chart of total sales for product X last month\"},\n",
        "+  {\"action\": \"interpret\", \"details\": \"interpret the bar chart of total sales for product X last month\"}\n",
        "+]\n",
        "+```\n",
        "+\n",
        "+\u4f8b3: \u30c7\u30fc\u30bf\u52a0\u5de5\u3092\u542b\u3080\u30ea\u30af\u30a8\u30b9\u30c8\n",
        "+\u30e6\u30fc\u30b6\u30fc\u306e\u30af\u30a8\u30ea: \"Load the customer dataset, then add a new column 'age_group' based on the 'age' column (e.g., <18: Teen, 18-65: Adult, >65: Senior), and show the first 5 rows of the processed data.\"\n",
        "+\u751f\u6210\u3055\u308c\u308b\u30d7\u30e9\u30f3:\n",
        "+```json\n",
        "+[\n",
        "+  {\"action\": \"check_history\", \"details\": [\"customer dataset\"]},\n",
        "+  {\"action\": \"sql\", \"details\": \"customer dataset\"},\n",
        "+  {\"action\": \"data_processing\", \"details\": \"Add a new column 'age_group' to DF_KEY['customer dataset'] based on the 'age' column (e.g., <18: Teen, 18-65: Adult, >65: Senior)\"},\n",
        "+  {\"action\": \"interpret\", \"details\": \"Describe the first 5 rows of the processed customer dataset (DF_KEY['customer dataset']) including the new 'age_group' column.\"}\n",
        "+]\n",
        "+```\n",
        "+\n",
        "+\u5fc5\u305aJSON\u5f62\u5f0f\u3067 plan_steps \u3092\u542b\u3080\u5fdc\u7b54\u3092\u751f\u6210\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n",
        "+\"\"\"\n",
        "+        prompt_parts = [SYSTEM_PROMPT]\n",
        "+\n",
        "+        # Add query history to prompt\n",
        "+        query_history = state.get(\"query_history\", [])\n",
        "+        MAX_HISTORY_LEN = 5 # \u6700\u5927\u5c65\u6b74\u6570\n",
        "+        if query_history:\n",
        "+            history_start_index = max(0, len(query_history) - MAX_HISTORY_LEN -1) # \u73fe\u5728\u306e\u30af\u30a8\u30ea\u306f\u9664\u304f\u305f\u3081-1\n",
        "+            relevant_history = query_history[history_start_index:-1] if len(query_history) > 1 else []\n",
        "+            if relevant_history:\n",
        "+                formatted_history = \"\\n\\n\u904e\u53bb\u306e\u95a2\u9023\u3059\u308b\u554f\u3044\u5408\u308f\u305b\u5c65\u6b74 (\u65b0\u3057\u3044\u3082\u306e\u304c\u6700\u5f8c):\\n\"\n",
        "+                for i, hist_item in enumerate(relevant_history):\n",
        "+                    formatted_history += f\"- {hist_item}\\n\"\n",
        "+                prompt_parts.append(formatted_history)\n",
        "+\n",
        "+        prompt_parts.append(\"\\n\u30e6\u30fc\u30b6\u30fc\u306e\u73fe\u5728\u306e\u30af\u30a8\u30ea: \")\n",
        "+        prompt_parts.append(user_query)\n",
        "+\n",
        "+        if user_clarification:\n",
        "+            prompt_parts.append(f\"\\n\u30e6\u30fc\u30b6\u30fc\u304b\u3089\u306e\u8ffd\u52a0\u60c5\u5831: {user_clarification}\")\n",
        "+            original_query = state.get(\"complex_analysis_original_query\", \"\")\n",
        "+            if original_query and original_query != user_query :\n",
        "+                 prompt_parts.append(f\"\\n(\u3053\u306e\u8ffd\u52a0\u60c5\u5831\u306f\u3001\u4ee5\u524d\u306e\u30af\u30a8\u30ea\u300c{original_query}\u300d\u306b\u95a2\u9023\u3057\u3066\u3044\u307e\u3059)\")\n",
        "+\n",
        "+        final_prompt_string = \"\".join(prompt_parts)\n",
        "+        logging.info(f\"Gemini\u3078\u306e\u6700\u7d42\u30d7\u30ed\u30f3\u30d7\u30c8:\\n{final_prompt_string}\")\n",
        "+\n",
        "+        # API\u30b3\u30fc\u30eb\u3068\u30ec\u30b9\u30dd\u30f3\u30b9\u51e6\u7406\n",
        "+        try:\n",
        "+            response = model.generate_content(\n",
        "+                final_prompt_string,\n",
        "+                tools=[plan_generation_tool],\n",
        "+                generation_config=genai.types.GenerationConfig(response_mime_type=\"application/json\")\n",
        "+            )\n",
        "+            logging.info(f\"Gemini\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9: {response}\")\n",
        " \n",
        "-    parsed_plan = None\n",
        "-    try:\n",
        "-        parsed_plan = json.loads(plan_json_str)\n",
        "-        if not isinstance(parsed_plan, list):\n",
        "-            raise ValueError(\"\u5206\u6790\u30d7\u30e9\u30f3\u304c\u30ea\u30b9\u30c8\u578b\u306b\u306a\u3063\u3066\u3044\u307e\u305b\u3093\u3002\")\n",
        "-        for step in parsed_plan:\n",
        "-            if not isinstance(step, dict) or \"action\" not in step or \"details\" not in step:\n",
        "-                raise ValueError(\"\u5206\u6790\u30d7\u30e9\u30f3\u5185\u306e\u5404\u30b9\u30c6\u30c3\u30d7\u304c\u6b63\u3057\u3044\u5f62\u5f0f\u3067\u306f\u3042\u308a\u307e\u305b\u3093\uff08'action'\u3068'details'\u5fc5\u9808\uff09\u3002\")\n",
        "-\n",
        "-    except (json.JSONDecodeError, ValueError) as e:\n",
        "-        logging.error(f\"\u5206\u6790\u8a08\u753b\u306e\u30d1\u30fc\u30b9\u30fb\u691c\u8a3c\u306b\u5931\u6557: {e}. Plan string: '{plan_json_str}'\")\n",
        "+            if not response.candidates or not response.candidates[0].content.parts:\n",
        "+                raise ValueError(\"Gemini\u304b\u3089\u306e\u30ec\u30b9\u30dd\u30f3\u30b9\u306b\u6709\u52b9\u306a\u5019\u88dc\u307e\u305f\u306f\u30d1\u30fc\u30c8\u304c\u3042\u308a\u307e\u305b\u3093\u3002\")\n",
        "+\n",
        "+            function_call_part = next((part for part in response.candidates[0].content.parts if part.function_call), None)\n",
        "+            \n",
        "+            if not function_call_part:\n",
        "+                raw_text_response = response.text if hasattr(response, 'text') else \"\u5229\u7528\u53ef\u80fd\u306a\u30c6\u30ad\u30b9\u30c8\u30ec\u30b9\u30dd\u30f3\u30b9\u304c\u3042\u308a\u307e\u305b\u3093\u3002\"\n",
        "+                logging.warning(f\"Gemini\u30ec\u30b9\u30dd\u30f3\u30b9\u306bfunction_call\u304c\u542b\u307e\u308c\u3066\u3044\u307e\u305b\u3093\u3002\u30c6\u30ad\u30b9\u30c8\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u8a66\u307f\u307e\u3059: {raw_text_response}\")\n",
        "+                try:\n",
        "+                    parsed_plan_from_text = json.loads(raw_text_response)\n",
        "+                    if not (isinstance(parsed_plan_from_text, list) and \\\n",
        "+                       all(isinstance(step, dict) and \"action\" in step and \"details\" in step for step in parsed_plan_from_text)):\n",
        "+                        raise ValueError(\"\u30c6\u30ad\u30b9\u30c8\u30ec\u30b9\u30dd\u30f3\u30b9\u306f\u6709\u52b9\u306a\u30d7\u30e9\u30f3\u5f62\u5f0f\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\")\n",
        "+                    logging.info(\"Gemini\u304c\u30c6\u30ad\u30b9\u30c8\u5f62\u5f0f\u3067\u6709\u52b9\u306a\u30d7\u30e9\u30f3\u3092\u8fd4\u3057\u307e\u3057\u305f\u3002\u3053\u308c\u3092\u63a1\u7528\u3057\u307e\u3059\u3002\")\n",
        "+                    plan_steps = parsed_plan_from_text\n",
        "+                except (json.JSONDecodeError, ValueError) as e_text_parse:\n",
        "+                    logging.error(f\"Gemini\u306e\u30c6\u30ad\u30b9\u30c8\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u30d1\u30fc\u30b9\u306b\u5931\u6557: {e_text_parse}\")\n",
        "+                    raise ValueError(f\"\u30e2\u30c7\u30eb\u5fdc\u7b54\u306f\u671f\u5f85\u3055\u308c\u308bfunction_call\u5f62\u5f0f\u3067\u306f\u306a\u304f\u3001\u30c6\u30ad\u30b9\u30c8\u5fdc\u7b54\u306e\u89e3\u6790\u306b\u3082\u5931\u6557\u3057\u307e\u3057\u305f\u3002\u8a73\u7d30: {e_text_parse}\") from e_text_parse\n",
        "+            else:\n",
        "+                function_args = function_call_part.function_call.args\n",
        "+                if not function_args or \"plan_steps\" not in function_args:\n",
        "+                    raise ValueError(\"Gemini\u30ec\u30b9\u30dd\u30f3\u30b9\u306efunction_call.args\u306bplan_steps\u304c\u542b\u307e\u308c\u3066\u3044\u307e\u305b\u3093\u3002\")\n",
        "+                plan_steps = function_args[\"plan_steps\"]\n",
        "+\n",
        "+            if isinstance(plan_steps, str): # plan_steps\u304c\u6587\u5b57\u5217\u3067JSON\u914d\u5217\u3068\u3057\u3066\u30a8\u30f3\u30b3\u30fc\u30c9\u3055\u308c\u3066\u3044\u308b\u5834\u5408\n",
        "+                try:\n",
        "+                    plan_steps = json.loads(plan_steps)\n",
        "+                except json.JSONDecodeError as e_json_str:\n",
        "+                    raise ValueError(f\"plan_steps\u306eJSON\u6587\u5b57\u5217\u306e\u30c7\u30b3\u30fc\u30c9\u306b\u5931\u6557: {e_json_str}. \u6587\u5b57\u5217: '{plan_steps}'\")\n",
        "+\n",
        "+            if not isinstance(plan_steps, list):\n",
        "+                raise ValueError(f\"plan_steps\u304c\u30ea\u30b9\u30c8\u5f62\u5f0f\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002\u578b: {type(plan_steps)}\")\n",
        "+\n",
        "+            for step in plan_steps: # \u5404\u30b9\u30c6\u30c3\u30d7\u306e\u691c\u8a3c\n",
        "+                if not (isinstance(step, dict) and \"action\" in step and \"details\" in step):\n",
        "+                    raise ValueError(\"\u5206\u6790\u30d7\u30e9\u30f3\u5185\u306e\u5404\u30b9\u30c6\u30c3\u30d7\u304c\u6b63\u3057\u3044\u5f62\u5f0f\u3067\u306f\u3042\u308a\u307e\u305b\u3093\uff08'action'\u3068'details'\u5fc5\u9808\uff09\u3002\")\n",
        "+                allowed_actions = {\"clarify\", \"check_history\", \"sql\", \"chart\", \"interpret\", \"data_processing\"}\n",
        "+                if step[\"action\"] not in allowed_actions:\n",
        "+                    logging.warning(f\"\u30d7\u30e9\u30f3\u306b\u672a\u77e5\u306e\u30a2\u30af\u30b7\u30e7\u30f3 '{step['action']}' \u304c\u542b\u307e\u308c\u3066\u3044\u307e\u3059\u3002\")\n",
        "+            \n",
        "+            parsed_plan = plan_steps\n",
        "+\n",
        "+        except google_exceptions.GoogleAPICallError as e_api:\n",
        "+            logging.error(f\"Gemini API\u547c\u3073\u51fa\u3057\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f: {e_api}\", exc_info=True)\n",
        "+            return {**state, \"analysis_plan\": None, \"current_plan_step_index\": None, \"user_clarification\": None,\n",
        "+                    \"condition\": \"plan_generation_failed\", \"error\": f\"\u5206\u6790\u8a08\u753b\u306e\u4f5c\u6210\u4e2d\u306b\u30e2\u30c7\u30eb\u547c\u3073\u51fa\u3057\u3067\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u7ba1\u7406\u8005\u306b\u3054\u9023\u7d61\u304f\u3060\u3055\u3044\u3002(\u8a73\u7d30: {e_api.message})\"}\n",
        "+        except (ValueError, AttributeError, json.JSONDecodeError) as e_parse:\n",
        "+            logging.error(f\"Gemini\u30ec\u30b9\u30dd\u30f3\u30b9\u306e\u51e6\u7406\u307e\u305f\u306f\u691c\u8a3c\u4e2d\u306b\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f: {e_parse}\", exc_info=True)\n",
        "+            return {**state, \"analysis_plan\": None, \"current_plan_step_index\": None, \"user_clarification\": None,\n",
        "+                    \"condition\": \"plan_generation_failed\", \"error\": f\"\u5206\u6790\u8a08\u753b\u306e\u751f\u6210\u4e2d\u306b\u30e2\u30c7\u30eb\u5fdc\u7b54\u306e\u89e3\u6790\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002\u5f62\u5f0f\u304c\u6b63\u3057\u304f\u306a\u3044\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002(\u8a73\u7d30: {str(e_parse)})\"}\n",
        "+\n",
        "+    except Exception as e_outer: # \u30e2\u30c7\u30eb\u521d\u671f\u5316\u3084\u30d7\u30ed\u30f3\u30d7\u30c8\u69cb\u7bc9\u306a\u3069\u3001API\u30b3\u30fc\u30eb\u4ee5\u5916\u306e\u90e8\u5206\u3067\u306e\u4e88\u671f\u305b\u306c\u30a8\u30e9\u30fc\n",
        "+        logging.error(f\"\u5206\u6790\u8a08\u753b\u4f5c\u6210\u30ce\u30fc\u30c9\u3067\u4e88\u671f\u305b\u306c\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f: {e_outer}\", exc_info=True)\n",
        "         return {\n",
        "-            **state,\n",
        "-            \"analysis_plan\": None,\n",
        "-            \"current_plan_step_index\": None,\n",
        "-            \"user_clarification\": None,\n",
        "-            \"condition\": \"plan_generation_failed\",\n",
        "-            \"error\": f\"\u5206\u6790\u8a08\u753b\u306e\u5f62\u5f0f\u3084\u5185\u5bb9\u306b\u4e0d\u5099\u304c\u3042\u308a\u307e\u3059: {e}\"\n",
        "+            **state, \"analysis_plan\": None, \"current_plan_step_index\": None, \"user_clarification\": None,\n",
        "+            \"condition\": \"plan_generation_failed\", \"error\": f\"\u5206\u6790\u8a08\u753b\u306e\u4f5c\u6210\u4e2d\u306b\u4e88\u671f\u305b\u306c\u30b7\u30b9\u30c6\u30e0\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\u3002\u7ba1\u7406\u8005\u306b\u3054\u9023\u7d61\u304f\u3060\u3055\u3044\u3002(\u8a73\u7d30: {str(e_outer)})\"\n",
        "         }\n",
        "-\n",
        "+        \n",
        "+    # current_input\u306e\u53d6\u5f97\u3068complex_analysis_original_query\u306e\u30ed\u30b8\u30c3\u30af\u306f\u5909\u66f4\u306a\u3057\n",
        "     current_input = state.get(\"input\", \"\")\n",
        "-    original_query_for_complex = state.get(\"complex_analysis_original_query\", current_input if parsed_plan else None)\n",
        "-    if user_clarification and not state.get(\"complex_analysis_original_query\"):\n",
        "-        original_query_for_complex = current_input\n",
        "-\n",
        "+    original_query_for_complex = state.get(\"complex_analysis_original_query\")\n",
        "+    if parsed_plan and not original_query_for_complex and \\\n",
        "+       (\"clarify\" in [step.get(\"action\") for step in parsed_plan if isinstance(step, dict)] or user_clarification) :\n",
        "+        original_query_for_complex = user_query\n",
        "+    \n",
        "+    # user_clarification \u306f\u3053\u3053\u3067\u6d88\u8cbb\u3055\u308c\u308b\u306e\u3067None\u306b\u3059\u308b\n",
        "     return {\n",
        "         **state,\n",
        "         \"complex_analysis_original_query\": original_query_for_complex,\n",
        "-        \"analysis_plan\": parsed_plan,\n",
        "+        \"analysis_plan\": parsed_plan, # parsed_plan\u304cNone\u306e\u5834\u5408\u3082\u3042\u308b\uff08\u30a8\u30e9\u30fc\u6642\u306a\u3069\uff09\n",
        "         \"current_plan_step_index\": 0 if parsed_plan else None,\n",
        "         \"awaiting_step_confirmation\": False,\n",
        "-        \"user_clarification\": None,\n",
        "-        \"condition\": \"plan_generated\" if parsed_plan else \"empty_plan_generated\",\n",
        "-        \"error\": None\n",
        "+        \"user_clarification\": None, \n",
        "+        \"condition\": \"plan_generated\" if parsed_plan else \"empty_plan_generated\", # \u30a8\u30e9\u30fc\u6642\u306fplan_generation_failed\u304c\u30bb\u30c3\u30c8\u3055\u308c\u3066\u3044\u308b\u306f\u305a\n",
        "+        \"error\": state.get(\"error\") # \u30a8\u30e9\u30fc\u6642\u306f\u3053\u3053\u3067\u30bb\u30c3\u30c8\u3055\u308c\u305f\u30a8\u30e9\u30fc\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u7dad\u6301\u3055\u308c\u308b\n",
        "     }\n",
        " \n",
        " #\u5206\u6790\u8a08\u753b\u306b\u57fa\u3065\u3044\u3066\u3001\u30e6\u30fc\u30b6\u30fc\u306b\u8cea\u554f\n"
      ]
    },
    {
      "path": "files/test_backend_codes.py",
      "status": "modified",
      "additions": 158,
      "deletions": 37,
      "patch": "@@ -173,57 +173,178 @@ def test_clarify_plan_for_ambiguous_query(self):\n         self.assertEqual(result_state[\"analysis_plan\"][0][\"action\"], \"clarify\")\n         self.assertIn(\"Could you please specify\", result_state[\"analysis_plan\"][0][\"details\"])\n         self.assertEqual(result_state[\"current_plan_step_index\"], 0)\n-        self.assertIsNone(result_state[\"user_clarification\"]) # Should be cleared\n+from google.api_core import exceptions as google_exceptions\n+import json # For creating mock JSON strings\n \n-    def test_plan_for_simple_data_query(self):\n-        state = MyState(input=\"show sales data\")\n+class TestCreateAnalysisPlanNode(unittest.TestCase):\n+\n+    def setUp(self):\n+        # Patch genai.GenerativeModel and genai.configure for all tests in this class\n+        self.patcher_model = patch('files.backend_codes.genai.GenerativeModel')\n+        self.patcher_configure = patch('files.backend_codes.genai.configure')\n+\n+        self.mock_generative_model_cls = self.patcher_model.start()\n+        self.mock_configure = self.patcher_configure.start()\n+\n+        # Mock the instance of GenerativeModel\n+        self.mock_model_instance = MagicMock()\n+        self.mock_generative_model_cls.return_value = self.mock_model_instance\n+        \n+        # This will be configured per test\n+        self.generate_content_mock = MagicMock()\n+        self.mock_model_instance.generate_content = self.generate_content_mock\n+\n+    def tearDown(self):\n+        self.patcher_model.stop()\n+        self.patcher_configure.stop()\n+\n+    def _create_mock_gemini_response(self, plan_steps_dict_or_str, has_function_call=True, text_response=None):\n+        response_mock = MagicMock()\n+        part_mock = MagicMock()\n+        \n+        if has_function_call:\n+            function_call_mock = MagicMock()\n+            # plan_steps_dict_or_str could be a dict for args, or a string if testing string parsing\n+            function_call_mock.args = plan_steps_dict_or_str if isinstance(plan_steps_dict_or_str, dict) else {\"plan_steps\": plan_steps_dict_or_str}\n+            part_mock.function_call = function_call_mock\n+            part_mock.text = None # Explicitly set text to None if function_call is present\n+        else:\n+            part_mock.function_call = None\n+            part_mock.text = text_response\n+            # If text_response is intended to be JSON, it should be a JSON string here.\n+\n+        response_mock.candidates = [MagicMock(content=MagicMock(parts=[part_mock]))]\n+        # Also mock the .text attribute on the top-level response for fallback\n+        response_mock.text = text_response if text_response else \"\" # Ensure .text exists\n+        return response_mock\n+\n+    def test_successful_plan_simple_query(self):\n+        expected_plan = [{\"action\": \"sql\", \"details\": \"total sales\"}]\n+        mock_response_args = {\"plan_steps\": expected_plan}\n+        self.generate_content_mock.return_value = self._create_mock_gemini_response(mock_response_args)\n+\n+        state = MyState(input=\"show total sales\")\n+        result_state = create_analysis_plan_node(state)\n+\n+        self.assertEqual(result_state[\"analysis_plan\"], expected_plan)\n+        self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n+        self.assertIsNone(result_state[\"error\"])\n+        self.generate_content_mock.assert_called_once()\n+\n+    def test_successful_plan_ambiguous_query_clarify(self):\n+        expected_plan = [{\"action\": \"clarify\", \"details\": \"Please specify the period for sales data.\"}]\n+        mock_response_args = {\"plan_steps\": expected_plan}\n+        self.generate_content_mock.return_value = self._create_mock_gemini_response(mock_response_args)\n+        \n+        state = MyState(input=\"sales data\")\n         result_state = create_analysis_plan_node(state)\n+\n+        self.assertEqual(result_state[\"analysis_plan\"], expected_plan)\n         self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n+        self.generate_content_mock.assert_called_once()\n+\n+    def test_successful_plan_multistep_query(self):\n         expected_plan = [\n-            {\"action\": \"check_history\", \"details\": [\"sales data\"]},\n-            {\"action\": \"sql\", \"details\": \"sales data\"},\n-            {\"action\": \"interpret\", \"details\": \"interpret sales data\"}\n+            {\"action\": \"sql\", \"details\": \"sales\"},\n+            {\"action\": \"chart\", \"details\": \"chart sales\"}\n         ]\n+        mock_response_args = {\"plan_steps\": expected_plan}\n+        self.generate_content_mock.return_value = self._create_mock_gemini_response(mock_response_args)\n+\n+        state = MyState(input=\"show sales, then chart it\")\n+        result_state = create_analysis_plan_node(state)\n+\n         self.assertEqual(result_state[\"analysis_plan\"], expected_plan)\n-        self.assertEqual(result_state[\"current_plan_step_index\"], 0)\n-        self.assertEqual(result_state[\"complex_analysis_original_query\"], \"show sales data\")\n+        self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n+        self.generate_content_mock.assert_called_once()\n+        \n+    def test_prompt_includes_query_history(self):\n+        history = [\"past query 1\", \"past query 2\"]\n+        current_query = \"current query based on history\"\n+        expected_plan = [{\"action\": \"sql\", \"details\": \"current query data\"}]\n+        mock_response_args = {\"plan_steps\": expected_plan}\n+        self.generate_content_mock.return_value = self._create_mock_gemini_response(mock_response_args)\n+\n+        state = MyState(input=current_query, query_history=history + [current_query]) # History includes current for this setup\n+        create_analysis_plan_node(state)\n+\n+        self.generate_content_mock.assert_called_once()\n+        called_prompt_string = self.generate_content_mock.call_args[0][0]\n+        self.assertIn(\"past query 1\", called_prompt_string)\n+        self.assertIn(\"past query 2\", called_prompt_string)\n+        self.assertIn(current_query, called_prompt_string)\n+        self.assertNotIn(\"past query 1\\n- past query 1\", called_prompt_string) # Ensure no self-repetition from history logic\n+\n+    def test_error_handling_api_call_failure(self):\n+        self.generate_content_mock.side_effect = google_exceptions.GoogleAPICallError(\"API error\")\n+\n+        state = MyState(input=\"any query\")\n+        result_state = create_analysis_plan_node(state)\n \n+        self.assertIsNone(result_state[\"analysis_plan\"])\n+        self.assertEqual(result_state[\"condition\"], \"plan_generation_failed\")\n+        self.assertIn(\"\u30e2\u30c7\u30eb\u547c\u3073\u51fa\u3057\u3067\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\", result_state[\"error\"])\n+        self.assertIn(\"API error\", result_state[\"error\"])\n \n-    def test_plan_with_user_clarification(self):\n-        original_query = \"show ambiguous sales\"\n-        clarification = \"for last month\"\n-        state = MyState(\n-            input=original_query, # Original input that led to clarification\n-            user_clarification=clarification,\n-            complex_analysis_original_query=original_query # This would have been set in a previous turn\n+    def test_error_handling_invalid_json_in_function_call_args(self):\n+        # Simulate function_call.args[\"plan_steps\"] being a string of malformed JSON\n+        malformed_json_string = '[{\"action\": \"sql\", \"details\": \"some data\"}, {\"action\": \"oops' # Invalid JSON\n+        mock_response_args = {\"plan_steps\": malformed_json_string} # plan_steps itself is the string\n+        self.generate_content_mock.return_value = self._create_mock_gemini_response(mock_response_args)\n+\n+        state = MyState(input=\"any query\")\n+        result_state = create_analysis_plan_node(state)\n+        \n+        self.assertIsNone(result_state[\"analysis_plan\"])\n+        self.assertEqual(result_state[\"condition\"], \"plan_generation_failed\")\n+        self.assertIn(\"\u30e2\u30c7\u30eb\u5fdc\u7b54\u306e\u89e3\u6790\u306b\u5931\u6557\u3057\u307e\u3057\u305f\", result_state[\"error\"])\n+        self.assertIn(\"plan_steps\u306eJSON\u6587\u5b57\u5217\u306e\u30c7\u30b3\u30fc\u30c9\u306b\u5931\u6557\", result_state[\"error\"])\n+\n+    def test_error_handling_no_function_call_invalid_text_fallback(self):\n+        # Simulate no function_call and text fallback is not valid JSON\n+        self.generate_content_mock.return_value = self._create_mock_gemini_response(\n+            plan_steps_dict_or_str=None, # No function call args\n+            has_function_call=False,\n+            text_response=\"This is not a valid JSON plan.\"\n         )\n+        \n+        state = MyState(input=\"any query\")\n         result_state = create_analysis_plan_node(state)\n-        self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n-        expected_plan = [\n-            {\"action\": \"check_history\", \"details\": [\"clarified sales data\"]}, # Mock logic uses \"clarified sales data\"\n-            {\"action\": \"sql\", \"details\": \"clarified sales data\"},\n-            {\"action\": \"interpret\", \"details\": \"interpret clarified sales data\"}\n-        ]\n-        self.assertEqual(result_state[\"analysis_plan\"], expected_plan)\n-        self.assertEqual(result_state[\"current_plan_step_index\"], 0)\n-        self.assertIsNone(result_state[\"user_clarification\"]) # Clarification should be consumed\n-        # complex_analysis_original_query should be preserved if already set\n-        self.assertEqual(result_state[\"complex_analysis_original_query\"], original_query)\n \n-    def test_plan_for_multi_step_query(self):\n-        state = MyState(input=\"show sales then chart it\")\n+        self.assertIsNone(result_state[\"analysis_plan\"])\n+        self.assertEqual(result_state[\"condition\"], \"plan_generation_failed\")\n+        self.assertIn(\"\u30e2\u30c7\u30eb\u5fdc\u7b54\u306f\u671f\u5f85\u3055\u308c\u308bfunction_call\u5f62\u5f0f\u3067\u306f\u306a\u304f\u3001\u30c6\u30ad\u30b9\u30c8\u5fdc\u7b54\u306e\u89e3\u6790\u306b\u3082\u5931\u6557\u3057\u307e\u3057\u305f\", result_state[\"error\"])\n+\n+    def test_successful_plan_from_text_fallback_if_no_function_call(self):\n+        expected_plan = [{\"action\": \"sql\", \"details\": \"data from text\"}]\n+        valid_json_text_response = json.dumps(expected_plan) # '[{\"action\": \"sql\", \"details\": \"data from text\"}]'\n+        \n+        self.generate_content_mock.return_value = self._create_mock_gemini_response(\n+            plan_steps_dict_or_str=None,\n+            has_function_call=False,\n+            text_response=valid_json_text_response\n+        )\n+\n+        state = MyState(input=\"query leading to text fallback\")\n         result_state = create_analysis_plan_node(state)\n-        self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n-        expected_plan = [\n-            {\"action\": \"check_history\", \"details\": [\"sales data\"]},\n-            {\"action\": \"sql\", \"details\": \"sales data\"},\n-            {\"action\": \"chart\", \"details\": \"chart sales data\"}\n-        ]\n+\n         self.assertEqual(result_state[\"analysis_plan\"], expected_plan)\n+        self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n+        self.assertIsNone(result_state[\"error\"])\n+\n+    def test_error_handling_model_initialization_failure(self):\n+        # Make the class constructor raise an error\n+        self.mock_generative_model_cls.side_effect = Exception(\"Model init failed\")\n+\n+        state = MyState(input=\"any query\")\n+        result_state = create_analysis_plan_node(state)\n \n-    # Test for JSON encoding/decoding errors (though hard with current mock structure)\n-    # These would require deeper patching of json.dumps or json.loads if we wanted to simulate failure\n-    # For now, the structure assumes json operations succeed with the mock plans.\n+        self.assertIsNone(result_state[\"analysis_plan\"])\n+        self.assertEqual(result_state[\"condition\"], \"plan_generation_failed\")\n+        self.assertIn(\"\u5206\u6790\u8a08\u753b\u306e\u4f5c\u6210\u4e2d\u306b\u4e88\u671f\u305b\u306c\u30b7\u30b9\u30c6\u30e0\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\", result_state[\"error\"])\n+        self.assertIn(\"Model init failed\", result_state[\"error\"])\n+        self.mock_configure.assert_not_called() # configure should not be called if model init fails\n+        self.generate_content_mock.assert_not_called()\n \n \n class TestSqlNode(unittest.TestCase):",
      "patch_lines": [
        "@@ -173,57 +173,178 @@ def test_clarify_plan_for_ambiguous_query(self):\n",
        "         self.assertEqual(result_state[\"analysis_plan\"][0][\"action\"], \"clarify\")\n",
        "         self.assertIn(\"Could you please specify\", result_state[\"analysis_plan\"][0][\"details\"])\n",
        "         self.assertEqual(result_state[\"current_plan_step_index\"], 0)\n",
        "-        self.assertIsNone(result_state[\"user_clarification\"]) # Should be cleared\n",
        "+from google.api_core import exceptions as google_exceptions\n",
        "+import json # For creating mock JSON strings\n",
        " \n",
        "-    def test_plan_for_simple_data_query(self):\n",
        "-        state = MyState(input=\"show sales data\")\n",
        "+class TestCreateAnalysisPlanNode(unittest.TestCase):\n",
        "+\n",
        "+    def setUp(self):\n",
        "+        # Patch genai.GenerativeModel and genai.configure for all tests in this class\n",
        "+        self.patcher_model = patch('files.backend_codes.genai.GenerativeModel')\n",
        "+        self.patcher_configure = patch('files.backend_codes.genai.configure')\n",
        "+\n",
        "+        self.mock_generative_model_cls = self.patcher_model.start()\n",
        "+        self.mock_configure = self.patcher_configure.start()\n",
        "+\n",
        "+        # Mock the instance of GenerativeModel\n",
        "+        self.mock_model_instance = MagicMock()\n",
        "+        self.mock_generative_model_cls.return_value = self.mock_model_instance\n",
        "+        \n",
        "+        # This will be configured per test\n",
        "+        self.generate_content_mock = MagicMock()\n",
        "+        self.mock_model_instance.generate_content = self.generate_content_mock\n",
        "+\n",
        "+    def tearDown(self):\n",
        "+        self.patcher_model.stop()\n",
        "+        self.patcher_configure.stop()\n",
        "+\n",
        "+    def _create_mock_gemini_response(self, plan_steps_dict_or_str, has_function_call=True, text_response=None):\n",
        "+        response_mock = MagicMock()\n",
        "+        part_mock = MagicMock()\n",
        "+        \n",
        "+        if has_function_call:\n",
        "+            function_call_mock = MagicMock()\n",
        "+            # plan_steps_dict_or_str could be a dict for args, or a string if testing string parsing\n",
        "+            function_call_mock.args = plan_steps_dict_or_str if isinstance(plan_steps_dict_or_str, dict) else {\"plan_steps\": plan_steps_dict_or_str}\n",
        "+            part_mock.function_call = function_call_mock\n",
        "+            part_mock.text = None # Explicitly set text to None if function_call is present\n",
        "+        else:\n",
        "+            part_mock.function_call = None\n",
        "+            part_mock.text = text_response\n",
        "+            # If text_response is intended to be JSON, it should be a JSON string here.\n",
        "+\n",
        "+        response_mock.candidates = [MagicMock(content=MagicMock(parts=[part_mock]))]\n",
        "+        # Also mock the .text attribute on the top-level response for fallback\n",
        "+        response_mock.text = text_response if text_response else \"\" # Ensure .text exists\n",
        "+        return response_mock\n",
        "+\n",
        "+    def test_successful_plan_simple_query(self):\n",
        "+        expected_plan = [{\"action\": \"sql\", \"details\": \"total sales\"}]\n",
        "+        mock_response_args = {\"plan_steps\": expected_plan}\n",
        "+        self.generate_content_mock.return_value = self._create_mock_gemini_response(mock_response_args)\n",
        "+\n",
        "+        state = MyState(input=\"show total sales\")\n",
        "+        result_state = create_analysis_plan_node(state)\n",
        "+\n",
        "+        self.assertEqual(result_state[\"analysis_plan\"], expected_plan)\n",
        "+        self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n",
        "+        self.assertIsNone(result_state[\"error\"])\n",
        "+        self.generate_content_mock.assert_called_once()\n",
        "+\n",
        "+    def test_successful_plan_ambiguous_query_clarify(self):\n",
        "+        expected_plan = [{\"action\": \"clarify\", \"details\": \"Please specify the period for sales data.\"}]\n",
        "+        mock_response_args = {\"plan_steps\": expected_plan}\n",
        "+        self.generate_content_mock.return_value = self._create_mock_gemini_response(mock_response_args)\n",
        "+        \n",
        "+        state = MyState(input=\"sales data\")\n",
        "         result_state = create_analysis_plan_node(state)\n",
        "+\n",
        "+        self.assertEqual(result_state[\"analysis_plan\"], expected_plan)\n",
        "         self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n",
        "+        self.generate_content_mock.assert_called_once()\n",
        "+\n",
        "+    def test_successful_plan_multistep_query(self):\n",
        "         expected_plan = [\n",
        "-            {\"action\": \"check_history\", \"details\": [\"sales data\"]},\n",
        "-            {\"action\": \"sql\", \"details\": \"sales data\"},\n",
        "-            {\"action\": \"interpret\", \"details\": \"interpret sales data\"}\n",
        "+            {\"action\": \"sql\", \"details\": \"sales\"},\n",
        "+            {\"action\": \"chart\", \"details\": \"chart sales\"}\n",
        "         ]\n",
        "+        mock_response_args = {\"plan_steps\": expected_plan}\n",
        "+        self.generate_content_mock.return_value = self._create_mock_gemini_response(mock_response_args)\n",
        "+\n",
        "+        state = MyState(input=\"show sales, then chart it\")\n",
        "+        result_state = create_analysis_plan_node(state)\n",
        "+\n",
        "         self.assertEqual(result_state[\"analysis_plan\"], expected_plan)\n",
        "-        self.assertEqual(result_state[\"current_plan_step_index\"], 0)\n",
        "-        self.assertEqual(result_state[\"complex_analysis_original_query\"], \"show sales data\")\n",
        "+        self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n",
        "+        self.generate_content_mock.assert_called_once()\n",
        "+        \n",
        "+    def test_prompt_includes_query_history(self):\n",
        "+        history = [\"past query 1\", \"past query 2\"]\n",
        "+        current_query = \"current query based on history\"\n",
        "+        expected_plan = [{\"action\": \"sql\", \"details\": \"current query data\"}]\n",
        "+        mock_response_args = {\"plan_steps\": expected_plan}\n",
        "+        self.generate_content_mock.return_value = self._create_mock_gemini_response(mock_response_args)\n",
        "+\n",
        "+        state = MyState(input=current_query, query_history=history + [current_query]) # History includes current for this setup\n",
        "+        create_analysis_plan_node(state)\n",
        "+\n",
        "+        self.generate_content_mock.assert_called_once()\n",
        "+        called_prompt_string = self.generate_content_mock.call_args[0][0]\n",
        "+        self.assertIn(\"past query 1\", called_prompt_string)\n",
        "+        self.assertIn(\"past query 2\", called_prompt_string)\n",
        "+        self.assertIn(current_query, called_prompt_string)\n",
        "+        self.assertNotIn(\"past query 1\\n- past query 1\", called_prompt_string) # Ensure no self-repetition from history logic\n",
        "+\n",
        "+    def test_error_handling_api_call_failure(self):\n",
        "+        self.generate_content_mock.side_effect = google_exceptions.GoogleAPICallError(\"API error\")\n",
        "+\n",
        "+        state = MyState(input=\"any query\")\n",
        "+        result_state = create_analysis_plan_node(state)\n",
        " \n",
        "+        self.assertIsNone(result_state[\"analysis_plan\"])\n",
        "+        self.assertEqual(result_state[\"condition\"], \"plan_generation_failed\")\n",
        "+        self.assertIn(\"\u30e2\u30c7\u30eb\u547c\u3073\u51fa\u3057\u3067\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\", result_state[\"error\"])\n",
        "+        self.assertIn(\"API error\", result_state[\"error\"])\n",
        " \n",
        "-    def test_plan_with_user_clarification(self):\n",
        "-        original_query = \"show ambiguous sales\"\n",
        "-        clarification = \"for last month\"\n",
        "-        state = MyState(\n",
        "-            input=original_query, # Original input that led to clarification\n",
        "-            user_clarification=clarification,\n",
        "-            complex_analysis_original_query=original_query # This would have been set in a previous turn\n",
        "+    def test_error_handling_invalid_json_in_function_call_args(self):\n",
        "+        # Simulate function_call.args[\"plan_steps\"] being a string of malformed JSON\n",
        "+        malformed_json_string = '[{\"action\": \"sql\", \"details\": \"some data\"}, {\"action\": \"oops' # Invalid JSON\n",
        "+        mock_response_args = {\"plan_steps\": malformed_json_string} # plan_steps itself is the string\n",
        "+        self.generate_content_mock.return_value = self._create_mock_gemini_response(mock_response_args)\n",
        "+\n",
        "+        state = MyState(input=\"any query\")\n",
        "+        result_state = create_analysis_plan_node(state)\n",
        "+        \n",
        "+        self.assertIsNone(result_state[\"analysis_plan\"])\n",
        "+        self.assertEqual(result_state[\"condition\"], \"plan_generation_failed\")\n",
        "+        self.assertIn(\"\u30e2\u30c7\u30eb\u5fdc\u7b54\u306e\u89e3\u6790\u306b\u5931\u6557\u3057\u307e\u3057\u305f\", result_state[\"error\"])\n",
        "+        self.assertIn(\"plan_steps\u306eJSON\u6587\u5b57\u5217\u306e\u30c7\u30b3\u30fc\u30c9\u306b\u5931\u6557\", result_state[\"error\"])\n",
        "+\n",
        "+    def test_error_handling_no_function_call_invalid_text_fallback(self):\n",
        "+        # Simulate no function_call and text fallback is not valid JSON\n",
        "+        self.generate_content_mock.return_value = self._create_mock_gemini_response(\n",
        "+            plan_steps_dict_or_str=None, # No function call args\n",
        "+            has_function_call=False,\n",
        "+            text_response=\"This is not a valid JSON plan.\"\n",
        "         )\n",
        "+        \n",
        "+        state = MyState(input=\"any query\")\n",
        "         result_state = create_analysis_plan_node(state)\n",
        "-        self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n",
        "-        expected_plan = [\n",
        "-            {\"action\": \"check_history\", \"details\": [\"clarified sales data\"]}, # Mock logic uses \"clarified sales data\"\n",
        "-            {\"action\": \"sql\", \"details\": \"clarified sales data\"},\n",
        "-            {\"action\": \"interpret\", \"details\": \"interpret clarified sales data\"}\n",
        "-        ]\n",
        "-        self.assertEqual(result_state[\"analysis_plan\"], expected_plan)\n",
        "-        self.assertEqual(result_state[\"current_plan_step_index\"], 0)\n",
        "-        self.assertIsNone(result_state[\"user_clarification\"]) # Clarification should be consumed\n",
        "-        # complex_analysis_original_query should be preserved if already set\n",
        "-        self.assertEqual(result_state[\"complex_analysis_original_query\"], original_query)\n",
        " \n",
        "-    def test_plan_for_multi_step_query(self):\n",
        "-        state = MyState(input=\"show sales then chart it\")\n",
        "+        self.assertIsNone(result_state[\"analysis_plan\"])\n",
        "+        self.assertEqual(result_state[\"condition\"], \"plan_generation_failed\")\n",
        "+        self.assertIn(\"\u30e2\u30c7\u30eb\u5fdc\u7b54\u306f\u671f\u5f85\u3055\u308c\u308bfunction_call\u5f62\u5f0f\u3067\u306f\u306a\u304f\u3001\u30c6\u30ad\u30b9\u30c8\u5fdc\u7b54\u306e\u89e3\u6790\u306b\u3082\u5931\u6557\u3057\u307e\u3057\u305f\", result_state[\"error\"])\n",
        "+\n",
        "+    def test_successful_plan_from_text_fallback_if_no_function_call(self):\n",
        "+        expected_plan = [{\"action\": \"sql\", \"details\": \"data from text\"}]\n",
        "+        valid_json_text_response = json.dumps(expected_plan) # '[{\"action\": \"sql\", \"details\": \"data from text\"}]'\n",
        "+        \n",
        "+        self.generate_content_mock.return_value = self._create_mock_gemini_response(\n",
        "+            plan_steps_dict_or_str=None,\n",
        "+            has_function_call=False,\n",
        "+            text_response=valid_json_text_response\n",
        "+        )\n",
        "+\n",
        "+        state = MyState(input=\"query leading to text fallback\")\n",
        "         result_state = create_analysis_plan_node(state)\n",
        "-        self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n",
        "-        expected_plan = [\n",
        "-            {\"action\": \"check_history\", \"details\": [\"sales data\"]},\n",
        "-            {\"action\": \"sql\", \"details\": \"sales data\"},\n",
        "-            {\"action\": \"chart\", \"details\": \"chart sales data\"}\n",
        "-        ]\n",
        "+\n",
        "         self.assertEqual(result_state[\"analysis_plan\"], expected_plan)\n",
        "+        self.assertEqual(result_state[\"condition\"], \"plan_generated\")\n",
        "+        self.assertIsNone(result_state[\"error\"])\n",
        "+\n",
        "+    def test_error_handling_model_initialization_failure(self):\n",
        "+        # Make the class constructor raise an error\n",
        "+        self.mock_generative_model_cls.side_effect = Exception(\"Model init failed\")\n",
        "+\n",
        "+        state = MyState(input=\"any query\")\n",
        "+        result_state = create_analysis_plan_node(state)\n",
        " \n",
        "-    # Test for JSON encoding/decoding errors (though hard with current mock structure)\n",
        "-    # These would require deeper patching of json.dumps or json.loads if we wanted to simulate failure\n",
        "-    # For now, the structure assumes json operations succeed with the mock plans.\n",
        "+        self.assertIsNone(result_state[\"analysis_plan\"])\n",
        "+        self.assertEqual(result_state[\"condition\"], \"plan_generation_failed\")\n",
        "+        self.assertIn(\"\u5206\u6790\u8a08\u753b\u306e\u4f5c\u6210\u4e2d\u306b\u4e88\u671f\u305b\u306c\u30b7\u30b9\u30c6\u30e0\u30a8\u30e9\u30fc\u304c\u767a\u751f\u3057\u307e\u3057\u305f\", result_state[\"error\"])\n",
        "+        self.assertIn(\"Model init failed\", result_state[\"error\"])\n",
        "+        self.mock_configure.assert_not_called() # configure should not be called if model init fails\n",
        "+        self.generate_content_mock.assert_not_called()\n",
        " \n",
        " \n",
        " class TestSqlNode(unittest.TestCase):\n"
      ]
    }
  ]
}